<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Nexariq AI - Code Assistant</title>
    
    <!-- Updated favicon to use Nexariq logo -->
    <link rel="icon" href="https://z-cdn-media.chatglm.cn/files/1d46b5c3-4a2c-43e0-8129-a67c7ca4c80b_pasted_image_1759040841309.jpg?auth_key=1790577586-d5291ba80bda4631918430ba65a8f682-0-c874bd93ec0e0b7077d1d0c132d27af3">
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=JetBrains+Mono:wght@400;500;600&family=Space+Grotesk:wght@300;400;500;600;700&family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github-dark.min.css">
    <link href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css' rel='stylesheet'>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/4.3.0/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/2.4.7/purify.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore-compat.js"></script>
    
    <!-- Monaco Editor -->
    <script src="https://cdn.jsdelivr.net/npm/monaco-editor@0.34.1/min/vs/loader.js"></script>
    
    <style>
        /* Enhanced Color Palette for Coding Focus */
        :root {
            /* Primary colors - Dark theme optimized for coding */
            --primary: #6366f1;
            --primary-dark: #4f46e5;
            --secondary: #22d3ee;
            --accent: #a855f7;
            --background: #0f172a;
            --surface: #1e293b;
            --surface-elevated: #334155;
            --surface-highlight: #475569;
            --border: #334155;
            --text-primary: #f1f5f9;
            --text-secondary: #cbd5e1;
            --text-tertiary: #94a3b8;
            --success: #10b981;
            --warning: #f59e0b;
            --error: #ef4444;
            --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.2);
            --shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
            --shadow-md: 0 10px 15px rgba(0, 0, 0, 0.3);
            --shadow-lg: 0 20px 25px rgba(0, 0, 0, 0.4);
            --radius-sm: 0.375rem;
            --radius: 0.5rem;
            --radius-lg: 0.75rem;
            --transition: all 0.2s ease;
            --logo-size: 40px;
            --gradient-primary: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            --gradient-accent: linear-gradient(135deg, #22d3ee 0%, #a855f7 100%);
            --code-bg: #1e293b;
            --code-border: #334155;
            --code-text: #e2e8f0;
            --editor-bg: #0f172a;
            --editor-line-numbers: #475569;
            --editor-selection: #334155;
            --editor-cursor: #22d3ee;
            --editor-keyword: #c792ea;
            --editor-string: #c3e88d;
            --editor-comment: #546e7a;
            --editor-function: #82aaff;
            --editor-variable: #f07178;
            --editor-number: #f78c6c;
            --nexariq-primary: #e46033;
            --nexariq-secondary: #25252b;
            --nexariq-accent: #ff6b35;
            --glow-primary: 0 0 20px rgba(99, 102, 241, 0.5);
            --glow-secondary: 0 0 20px rgba(34, 211, 238, 0.5);
            --glow-accent: 0 0 20px rgba(168, 85, 247, 0.5);
        }

        /* Light theme variables */
        [data-theme="light"] {
            --background: #f8fafc;
            --surface: #ffffff;
            --surface-elevated: #f1f5f9;
            --surface-highlight: #e2e8f0;
            --border: #e2e8f0;
            --text-primary: #1e293b;
            --text-secondary: #475569;
            --text-tertiary: #64748b;
            --code-bg: #f1f5f9;
            --code-border: #e2e8f0;
            --code-text: #1e293b;
            --editor-bg: #ffffff;
            --editor-line-numbers: #e2e8f0;
            --editor-selection: #e2e8f0;
            --editor-cursor: #3b82f6;
            --editor-keyword: #8b5cf6;
            --editor-string: #10b981;
            --editor-comment: #64748b;
            --editor-function: #3b82f6;
            --editor-variable: #ef4444;
            --editor-number: #f59e0b;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--background);
            color: var(--text-primary);
            line-height: 1.6;
            overflow: hidden;
            height: 100vh;
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        /* Login Screen - Enhanced Design */
        .login-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            transition: opacity 0.3s ease, visibility 0.3s ease;
            overflow: hidden;
            padding: 20px;
        }

        .login-screen.hidden {
            opacity: 0;
            visibility: hidden;
        }

        .container {
            position: relative;
            width: 900px;
            height: 600px;
            border: 1px solid rgba(99, 102, 241, 0.3);
            box-shadow: 0 0 30px rgba(99, 102, 241, 0.3);
            overflow: hidden;
            border-radius: 20px;
            max-width: 100%;
            background: rgba(30, 41, 59, 0.9);
            backdrop-filter: blur(10px);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .container .form-box {
            position: absolute;
            top: 0;
            width: 50%;
            height: 100%;
            display: flex;
            justify-content: center;
            flex-direction: column;
            padding: 20px;
            z-index: 10;
            box-sizing: border-box;
        }

        .form-box.Login {
            left: 0;
            padding: 0 30px;
            max-width: 450px;
        }

        .form-box.Register {
            right: 0;
            padding: 0 30px;
            max-width: 450px;
        }

        .form-box.Login .animation {
            transform: translateX(0%);
            transition: .7s;
            opacity: 1;
            transition-delay: calc(.1s * var(--S));
        }

        .container.active .form-box.Login .animation {
            transform: translateX(-120%);
            opacity: 0;
            transition-delay: calc(.1s * var(--D));
        }

        .form-box.Register .animation {
            transform: translateX(120%);
            transition: .7s ease;
            opacity: 0;
            filter: blur(10px);
            transition-delay: calc(.1s * var(--S));
        }

        .container.active .form-box.Register .animation {
            transform: translateX(0%);
            opacity: 1;
            filter: blur(0px);
            transition-delay: calc(.1s * var(--li));
        }

        /* Brand Logo and Name - Enhanced */
        .brand-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-bottom: 20px;
            position: relative;
            z-index: 5;
        }

        .brand-logo {
            width: 60px;
            height: 60px;
            margin-bottom: 10px;
            border-radius: 50%;
            border: 2px solid var(--nexariq-primary);
            box-shadow: 0 0 20px rgba(228, 96, 51, 0.6);
            transition: all 0.3s ease;
            object-fit: cover;
        }

        .brand-logo:hover {
            transform: scale(1.05);
            box-shadow: 0 0 25px rgba(228, 96, 51, 0.8);
        }

        .brand-name {
            font-size: 22px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1.5px;
            animation: rgb-blink 1.5s infinite;
            text-align: center;
            margin-top: 5px;
            text-shadow: 0 0 10px rgba(255, 255, 255, 0.3);
            line-height: 1.2;
            background: var(--gradient-primary);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        /* RGB blinking animation */
        @keyframes rgb-blink {
            0% { 
                color: #ff0000; 
                text-shadow: 0 0 10px #ff0000, 0 0 20px #ff0000;
            }
            25% { 
                color: #00ff00; 
                text-shadow: 0 0 10px #00ff00, 0 0 20px #00ff00;
            }
            50% { 
                color: #0000ff; 
                text-shadow: 0 0 10px #0000ff, 0 0 20px #0000ff;
            }
            75% { 
                color: #ff00ff; 
                text-shadow: 0 0 10px #ff00ff, 0 0 20px #ff00ff;
            }
            100% { 
                color: #ff0000; 
                text-shadow: 0 0 10px #ff0000, 0 0 20px #ff0000;
            }
        }

        .form-box h2 {
            font-size: 28px;
            text-align: center;
            margin-bottom: 15px;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .form-box .input-box {
            position: relative;
            width: 100%;
            height: 45px;
            margin-top: 15px;
        }

        .input-box input {
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            outline: none;
            font-size: 14px;
            color: #fff;
            font-weight: 500;
            border-radius: 8px;
            padding: 0 40px 0 15px;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        }

        .input-box input:focus,
        .input-box input:valid {
            background: rgba(255, 255, 255, 0.1);
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.2);
        }

        .input-box label {
            position: absolute;
            top: 50%;
            left: 15px;
            transform: translateY(-50%);
            font-size: 14px;
            color: rgba(255, 255, 255, 0.7);
            transition: all 0.3s ease;
            pointer-events: none;
        }

        .input-box input:focus ~ label,
        .input-box input:valid ~ label {
            top: -10px;
            left: 10px;
            font-size: 11px;
            color: var(--primary);
            background: #1e293b;
            padding: 0 5px;
            border-radius: 3px;
        }

        .input-box i {
            position: absolute;
            top: 50%;
            right: 15px;
            font-size: 16px;
            transform: translateY(-50%);
            color: rgba(255, 255, 255, 0.7);
            transition: all 0.3s ease;
        }

        .input-box input:focus ~ i,
        .input-box input:valid ~ i {
            color: var(--primary);
        }

        .btn {
            position: relative;
            width: 100%;
            height: 45px;
            background: linear-gradient(45deg, var(--primary), var(--accent));
            border-radius: 8px;
            cursor: pointer;
            font-size: 15px;
            font-weight: 600;
            border: none;
            overflow: hidden;
            z-index: 1;    
            margin-top: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
            letter-spacing: 0.8px;
            box-shadow: 0 4px 10px rgba(99, 102, 241, 0.4);
            transition: all 0.3s ease;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(99, 102, 241, 0.6);
        }

        .btn::before {
            content: "";
            position: absolute;
            height: 100%;
            width: 100%;
            background: linear-gradient(45deg, var(--accent), var(--primary));
            top: 0;
            left: 0;
            z-index: -1;
            transition: all 0.5s ease;
            opacity: 0;
        }

        .btn:hover::before {
            opacity: 1;
        }

        /* Google Button Style - Enhanced */
        .google-btn {
            position: relative;
            width: 100%;
            height: 45px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            cursor: pointer;
            font-size: 15px;
            font-weight: 500;
            border: 1px solid rgba(255, 255, 255, 0.1);
            overflow: hidden;
            z-index: 1;    
            margin-top: 15px;
            display: flex;
            justify-content: center;
            align-items: center;
            color: #fff;
            text-decoration: none;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        }

        .google-btn:hover {
            background: rgba(66, 133, 244, 0.2);
            border-color: #4285f4;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(66, 133, 244, 0.3);
        }

        .google-btn i {
            margin-right: 8px;
            font-size: 18px;
            color: #4285f4;
        }

        .divider {
            display: flex;
            align-items: center;
            margin: 20px 0;
            color: rgba(255, 255, 255, 0.5);
            font-size: 13px;
            font-weight: 500;
        }

        .divider::before,
        .divider::after {
            content: "";
            flex: 1;
            height: 1px;
            background: rgba(255, 255, 255, 0.2);
        }

        .divider span {
            padding: 0 15px;
        }

        .regi-link {
            font-size: 13px;
            text-align: center;
            margin: 15px 0 5px;
            color: rgba(255, 255, 255, 0.8);
        }

        .regi-link a {
            text-decoration: none;
            color: var(--primary);
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .regi-link a:hover {
            text-decoration: underline;
            color: var(--accent);
        }

        .info-content {
            position: absolute;
            top: 0;
            height: 100%;
            width: 50%;
            display: flex;
            justify-content: center;
            flex-direction: column;
            z-index: 5;
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.1), rgba(30, 41, 59, 0.3));
            backdrop-filter: blur(5px);
            padding: 20px;
            box-sizing: border-box;
        }

        .info-content.Login {
            right: 0;
            text-align: right;
            padding: 0 20px 40px 120px;
        }

        .info-content.Login .animation {
            transform: translateX(0);
            transition: .7s ease;
            transition-delay: calc(.1s * var(--S));
            opacity: 1;
            filter: blur(0px);
        }

        .container.active .info-content.Login .animation {
            transform: translateX(120%);
            opacity: 0;
            filter: blur(10px);
            transition-delay: calc(.1s * var(--D));
        }

        .info-content.Register {
            left: 0;
            text-align: left;
            padding: 0 120px 40px 20px;
            pointer-events: none;
        }

        .info-content.Register .animation {
            transform: translateX(-120%);
            transition: .7s ease;
            opacity: 0;
            filter: blur(10PX);
            transition-delay: calc(.1s * var(--S));
        }

        .container.active .info-content.Register .animation {
            transform: translateX(0%);
            opacity: 1;
            filter: blur(0);
            transition-delay: calc(.1s * var(--li));
        }

        .info-content h2 {
            text-transform: uppercase;
            font-size: 32px;
            line-height: 1.3;
            margin-bottom: 15px;
            font-weight: 700;
            letter-spacing: 1px;
            text-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
            color: var(--text-primary);
        }

        .info-content p {
            font-size: 14px;
            line-height: 1.6;
            color: rgba(255, 255, 255, 0.9);
        }

        .container .curved-shape {
            position: absolute;
            right: 0;
            top: -5px;
            height: 650px;
            width: 920px;
            background: linear-gradient(45deg, rgba(99, 102, 241, 0.8), rgba(168, 85, 247, 0.6));
            transform: rotate(10deg) skewY(40deg);
            transform-origin: bottom right;
            transition: 1.5s ease;
            transition-delay: 1.6s;
            z-index: 1;
            opacity: 0.8;
        }

        .container.active .curved-shape {
            transform: rotate(0deg) skewY(0deg);
            transition-delay: .5s;
        }

        .container .curved-shape2 {
            position: absolute;
            left: 250px;
            top: 100%;
            height: 750px;
            width: 920px;
            background: rgba(30, 41, 59, 0.9);
            border-top: 3px solid var(--primary);
            transform: rotate(0deg) skewY(0deg);
            transform-origin: bottom left;
            transition: 1.5s ease;
            transition-delay: .5s;
            z-index: 1;
        }

        .container.active .curved-shape2 {
            transform: rotate(-11deg) skewY(-41deg);
            transition-delay: 1.2s;
        }

        /* Error message styling */
        .login-error {
            margin-top: 10px;
            padding: 10px 15px;
            background-color: rgba(239, 68, 68, 0.1);
            border: 1px solid var(--error);
            border-radius: 8px;
            color: var(--error);
            font-size: 13px;
            text-align: center;
            line-height: 1.4;
            display: none;
        }

        .login-error.show {
            display: block;
        }

        /* Success message styling */
        .login-success {
            margin-top: 10px;
            padding: 10px 15px;
            background-color: rgba(16, 185, 129, 0.1);
            border: 1px solid var(--success);
            border-radius: 8px;
            color: var(--success);
            font-size: 13px;
            text-align: center;
            line-height: 1.4;
            display: none;
        }

        .login-success.show {
            display: block;
        }

        /* Loading spinner */
        .spinner {
            display: inline-block;
            width: 18px;
            height: 18px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Mobile Responsiveness - Login Screen */
        @media (max-width: 768px) {
            .login-screen {
                padding: 10px;
                background: var(--background);
                overflow-y: auto;
            }
            
            .container {
                width: 95%;
                max-width: 500px;
                height: auto;
                min-height: 650px;
                border-radius: 15px;
                border: 1px solid var(--primary);
                box-shadow: 0 0 20px rgba(99, 102, 241, 0.4);
                margin: 20px auto;
                overflow: hidden;
                position: relative;
            }
            
            .container .form-box {
                position: absolute;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                padding: 30px 20px;
                z-index: 10;
                box-sizing: border-box;
                transition: transform 0.7s ease, opacity 0.7s ease;
                display: flex;
                flex-direction: column;
                justify-content: center;
            }
            
            .form-box.Login {
                transform: translateY(0);
                opacity: 1;
            }
            
            .form-box.Register {
                transform: translateY(100%);
                opacity: 0;
            }
            
            .container.active .form-box.Login {
                transform: translateY(-100%);
                opacity: 0;
            }
            
            .container.active .form-box.Register {
                transform: translateY(0);
                opacity: 1;
            }
            
            .brand-container {
                margin-bottom: 30px;
            }
            
            .brand-logo {
                width: 70px;
                height: 70px;
                margin-bottom: 15px;
            }
            
            .brand-name {
                font-size: 24px;
                letter-spacing: 1.5px;
            }
            
            .form-box h2 {
                font-size: 28px;
                margin-bottom: 20px;
            }
            
            .input-box {
                height: 50px;
                margin-top: 15px;
            }
            
            .input-box input {
                font-size: 16px;
                padding: 0 40px 0 15px;
                height: 100%;
            }
            
            .input-box label {
                font-size: 14px;
            }
            
            .input-box i {
                font-size: 18px;
                right: 15px;
            }
            
            .btn, .google-btn {
                height: 50px;
                font-size: 16px;
                margin-top: 20px;
                border-radius: 8px;
            }
            
            .btn::before, .google-btn::before {
                border-radius: 8px;
            }
            
            .divider {
                margin: 20px 0;
                font-size: 14px;
            }
            
            .regi-link {
                font-size: 14px;
                margin: 20px 0;
            }
            
            .login-error, .login-success {
                margin-top: 15px;
                padding: 12px;
                font-size: 14px;
            }
            
            /* Hide info content on mobile */
            .info-content {
                display: none;
            }
            
            /* Hide curved shapes on mobile */
            .curved-shape, .curved-shape2 {
                display: none;
            }
            
            /* Adjust animations for mobile */
            .form-box.Login .animation {
                transform: translateY(0);
                opacity: 1;
                transition: transform 0.7s ease, opacity 0.7s ease;
            }
            
            .container.active .form-box.Login .animation {
                transform: translateY(-20px);
                opacity: 0;
            }
            
            .form-box.Register .animation {
                transform: translateY(20px);
                opacity: 0;
                transition: transform 0.7s ease, opacity 0.7s ease;
            }
            
            .container.active .form-box.Register .animation {
                transform: translateY(0);
                opacity: 1;
            }
        }
        
        /* Small phones */
        @media (max-width: 480px) {
            .container {
                width: 98%;
                max-width: none;
                min-height: 600px;
            }
            
            .brand-logo {
                width: 60px;
                height: 60px;
            }
            
            .brand-name {
                font-size: 20px;
            }
            
            .form-box h2 {
                font-size: 24px;
            }
            
            .input-box {
                height: 45px;
            }
            
            .btn, .google-btn {
                height: 45px;
                font-size: 15px;
            }
        }

        /* App Container - Enhanced */
        .app-container {
            display: flex;
            height: 100vh;
            overflow: hidden;
        }

        .app-container.hidden {
            display: none;
        }

        /* Sidebar - Enhanced */
        .sidebar {
            width: 280px;
            background-color: var(--surface);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            transition: var(--transition);
            z-index: 10;
        }

        .sidebar-header {
            padding: 1.5rem;
            border-bottom: 1px solid var(--border);
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            font-family: 'Space Grotesk', sans-serif;
            font-weight: 700;
            font-size: 1.25rem;
            color: var(--text-primary);
            text-decoration: none;
            margin-bottom: 1rem;
            position: relative;
        }

        .logo-img {
            width: var(--logo-size);
            height: var(--logo-size);
            object-fit: contain;
            border-radius: var(--radius);
        }

        .logo-icon {
            width: var(--logo-size);
            height: var(--logo-size);
            border-radius: var(--radius);
            background: var(--gradient-primary);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.2rem;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(99, 102, 241, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(99, 102, 241, 0); }
            100% { box-shadow: 0 0 0 0 rgba(99, 102, 241, 0); }
        }

        .logo-text {
            background: var(--gradient-primary);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            letter-spacing: 0.5px;
            text-transform: uppercase;
        }

        .new-chat-btn {
            width: 100%;
            padding: 0.75rem;
            background-color: var(--surface-highlight);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            color: var(--text-primary);
            font-weight: 500;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        .new-chat-btn:hover {
            background-color: var(--surface-elevated);
            box-shadow: var(--shadow-sm);
        }

        /* Chat history with improved organization */
        .chat-history {
            flex: 1;
            overflow-y: auto;
            padding: 1rem;
            -webkit-overflow-scrolling: touch;
        }

        .chat-history-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.75rem;
        }

        .chat-history-title {
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--text-tertiary);
            text-transform: uppercase;
        }

        .chat-history-actions {
            display: flex;
            gap: 0.5rem;
        }

        .chat-history-action-btn {
            width: 24px;
            height: 24px;
            border-radius: var(--radius-sm);
            background-color: transparent;
            border: none;
            color: var(--text-tertiary);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: var(--transition);
            font-size: 0.875rem;
        }

        .chat-history-action-btn:hover {
            background-color: var(--surface-highlight);
            color: var(--text-primary);
        }

        /* Chat group headers for date grouping */
        .chat-group-header {
            padding: 0.5rem 1rem;
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--text-tertiary);
            text-transform: uppercase;
            background-color: var(--surface);
            position: sticky;
            top: 0;
            z-index: 1;
            margin-top: 0.5rem;
            margin-bottom: 0.25rem;
        }

        /* Improved chat item layout */
        .chat-item {
            padding: 0.75rem 1rem;
            border-radius: var(--radius);
            cursor: pointer;
            transition: var(--transition);
            margin-bottom: 0.25rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            position: relative;
        }

        .chat-item:hover {
            background-color: var(--surface-highlight);
        }

        .chat-item.active {
            background-color: var(--primary);
        }

        .chat-item.pinned {
            border-left: 3px solid var(--warning);
        }

        .chat-item-icon {
            width: 32px;
            height: 32px;
            border-radius: var(--radius-sm);
            background-color: var(--surface-elevated);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-secondary);
            flex-shrink: 0;
        }

        .chat-item-content {
            flex: 1;
            min-width: 0;
        }

        .chat-item-title {
            font-weight: 500;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            color: var(--text-primary);
        }

        .chat-item-date {
            font-size: 0.75rem;
            color: var(--text-tertiary);
        }

        .chat-item-actions {
            display: flex;
            gap: 0.25rem;
            opacity: 0;
            transition: opacity 0.2s ease;
        }

        .chat-item:hover .chat-item-actions {
            opacity: 1;
        }

        .chat-item-action-btn {
            width: 24px;
            height: 24px;
            border-radius: var(--radius-sm);
            background-color: transparent;
            border: none;
            color: var(--text-tertiary);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: var(--transition);
            font-size: 0.75rem;
        }

        .chat-item-action-btn:hover {
            background-color: var(--surface-highlight);
            color: var(--text-primary);
        }

        .chat-item-action-btn.delete:hover {
            color: var(--error);
        }

        .chat-item-action-btn.pin:hover {
            color: var(--warning);
        }

        .chat-item-action-btn.rename:hover {
            color: var(--primary);
        }

        .sidebar-footer {
            padding: 1rem;
            border-top: 1px solid var(--border);
        }

        .user-menu {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem;
            border-radius: var(--radius);
            cursor: pointer;
            transition: var(--transition);
        }

        .user-menu:hover {
            background-color: var(--surface-highlight);
        }

        .user-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: var(--gradient-primary);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
        }

        .user-info {
            flex: 1;
            min-width: 0;
        }

        .user-name {
            font-weight: 600;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            background: var(--gradient-primary);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .user-email {
            font-size: 0.75rem;
            color: var(--text-tertiary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* Main Content - Enhanced */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* Header - Enhanced */
        .header {
            height: 70px;
            background-color: var(--surface);
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 1.5rem;
            z-index: 5;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .mobile-menu-btn {
            display: none;
            background: none;
            border: none;
            color: var(--text-primary);
            font-size: 1.25rem;
            cursor: pointer;
        }

        .mobile-back-btn {
            display: none;
            background: none;
            border: none;
            color: var(--text-primary);
            font-size: 1.25rem;
            cursor: pointer;
            margin-right: 0.5rem;
        }

        .mobile-back-btn.visible {
            display: block;
        }

        .header-title {
            font-family: 'Space Grotesk', sans-serif;
            font-size: 1.25rem;
            font-weight: 600;
            background: var(--gradient-primary);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            text-transform: uppercase;
        }

        .header-actions {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .header-btn {
            width: 40px;
            height: 40px;
            border-radius: var(--radius);
            background-color: transparent;
            border: 1px solid var(--border);
            color: var(--text-primary);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: var(--transition);
        }

        .header-btn:hover {
            background-color: var(--surface-highlight);
            box-shadow: var(--shadow-sm);
        }

        /* Chat Container - Enhanced */
        .chat-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 1.5rem;
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
            scroll-behavior: smooth;
            padding-bottom: 2rem;
        }

        .message {
            display: flex;
            gap: 1rem;
            max-width: 90%;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .message.user {
            align-self: flex-end;
            flex-direction: row-reverse;
        }

        .message.ai {
            align-self: flex-start;
        }

        .message-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            overflow: hidden;
            background-color: var(--primary);
        }

        .message-avatar-img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 50%;
        }

        .message.user .message-avatar {
            background: var(--gradient-primary);
            color: white;
        }

        .message.ai .message-avatar {
            background-color: var(--primary);
            color: white;
            font-size: 1.2rem;
        }

        .message-content {
            background-color: var(--surface-elevated);
            border-radius: var(--radius-lg);
            padding: 1rem 1.25rem;
            position: relative;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            word-wrap: break-word;
            overflow-wrap: break-word;
            max-width: 100%;
        }

        .message:hover .message-content {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .message.user .message-content {
            background: var(--gradient-primary);
            color: white;
            border-bottom-right-radius: var(--radius-sm);
        }

        .message.ai .message-content {
            border-bottom-left-radius: var(--radius-sm);
        }

        .message-text {
            line-height: 1.6;
            overflow-wrap: break-word;
            word-wrap: break-word;
            word-break: break-word;
        }

        /* Table styles */
        .message-text table {
            width: 100%;
            border-collapse: collapse;
            margin: 1rem 0;
            font-size: 0.9rem;
        }

        .message-text th, .message-text td {
            border: 1px solid var(--border);
            padding: 0.5rem;
            text-align: left;
        }

        .message-text th {
            background-color: rgba(99, 102, 241, 0.1);
            font-weight: 600;
        }

        .message-text tr:nth-child(even) {
            background-color: rgba(0, 0, 0, 0.03);
        }

        /* Box styles */
        .message-text blockquote {
            border-left: 4px solid var(--primary);
            margin: 1rem 0;
            padding: 0.75rem 1rem;
            background-color: rgba(99, 102, 241, 0.05);
            border-radius: 0 var(--radius-sm) var(--radius-sm) 0;
        }

        .message-text .info-box {
            background-color: rgba(99, 102, 241, 0.05);
            border: 1px solid var(--primary);
            border-radius: var(--radius);
            padding: 1rem;
            margin: 1rem 0;
        }

        .message-text .info-box-title {
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: var(--primary);
        }

        .message-text pre {
            background-color: var(--code-bg);
            border-radius: var(--radius);
            padding: 1rem;
            overflow-x: auto;
            margin: 0.75rem 0;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.875rem;
            border: 1px solid var(--code-border);
            color: var(--code-text);
            white-space: pre;
            word-break: normal;
            word-wrap: normal;
            max-width: 100%;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: thin;
            scrollbar-color: var(--border) var(--surface-elevated);
        }

        .message-text pre::-webkit-scrollbar {
            height: 8px;
        }

        .message-text pre::-webkit-scrollbar-track {
            background: var(--surface-elevated);
        }

        .message-text pre::-webkit-scrollbar-thumb {
            background: var(--border);
            border-radius: 4px;
        }

        .message-text pre::-webkit-scrollbar-thumb:hover {
            background: var(--text-tertiary);
        }

        .message-text code {
            font-family: 'JetBrains Mono', monospace;
            background-color: rgba(99, 102, 241, 0.1);
            padding: 0.125rem 0.25rem;
            border-radius: 0.25rem;
            font-size: 0.875em;
        }

        .message-text ul, .message-text ol {
            margin-left: 1.5rem;
            margin-top: 0.5rem;
            margin-bottom: 0.5rem;
        }

        .message-text h1, .message-text h2, .message-text h3 {
            margin-top: 1rem;
            margin-bottom: 0.5rem;
        }

        .message-actions {
            display: flex;
            gap: 0.5rem;
            margin-top: 0.75rem;
            opacity: 0;
            transition: opacity 0.2s ease;
        }

        .message:hover .message-actions {
            opacity: 1;
        }

        .message-action-btn {
            width: 32px;
            height: 32px;
            border-radius: var(--radius-sm);
            background-color: rgba(255, 255, 255, 0.05);
            border: none;
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: var(--transition);
            position: relative;
            overflow: hidden;
        }

        .message-action-btn:hover {
            background-color: rgba(255, 255, 255, 0.1);
            color: var(--text-primary);
        }

        .message-action-btn:active {
            background-color: rgba(99, 102, 241, 0.1);
        }

        .message-action-btn.liked {
            color: var(--success);
        }

        .message-action-btn.disliked {
            color: var(--error);
        }

        .message-action-btn.copied {
            color: var(--success);
        }

        .message-action-btn .tooltip {
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background-color: var(--surface-elevated);
            color: var(--text-primary);
            padding: 0.25rem 0.5rem;
            border-radius: var(--radius-sm);
            font-size: 0.75rem;
            white-space: nowrap;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s ease;
            margin-bottom: 0.5rem;
            box-shadow: var(--shadow-sm);
            z-index: 10;
        }

        .message-action-btn:hover .tooltip {
            opacity: 1;
        }

        .message-time {
            font-size: 0.75rem;
            color: var(--text-tertiary);
            margin-top: 0.25rem;
            display: block;
        }

        /* Typing Indicator */
        .typing-indicator {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 1rem;
            background-color: var(--surface-elevated);
            border-radius: var(--radius-lg);
            border-bottom-left-radius: var(--radius-sm);
            width: fit-content;
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0% { opacity: 0.7; }
            50% { opacity: 1; }
            100% { opacity: 0.7; }
        }

        .typing-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: var(--text-tertiary);
            animation: typing 1.4s infinite;
        }

        .typing-dot:nth-child(2) {
            animation-delay: 0.2s;
        }

        .typing-dot:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes typing {
            0%, 60%, 100% {
                transform: translateY(0);
                opacity: 0.7;
            }
            30% {
                transform: translateY(-10px);
                opacity: 1;
            }
        }

        /* Enhanced Code Editor Container */
        .code-editor-container {
            display: flex;
            flex-direction: column;
            height: 100%;
            background-color: var(--editor-bg);
            border-radius: var(--radius-lg);
            overflow: hidden;
            box-shadow: var(--shadow-lg);
            border: 1px solid var(--border);
        }

        .code-editor-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.75rem 1rem;
            background-color: var(--surface-elevated);
            border-bottom: 1px solid var(--border);
        }

        .code-editor-title {
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .code-editor-actions {
            display: flex;
            gap: 0.5rem;
        }

        .code-editor-btn {
            width: 32px;
            height: 32px;
            border-radius: var(--radius-sm);
            background-color: transparent;
            border: none;
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: var(--transition);
        }

        .code-editor-btn:hover {
            background-color: var(--surface-highlight);
            color: var(--text-primary);
        }

        .code-editor-btn.run {
            background-color: var(--success);
            color: white;
        }

        .code-editor-btn.run:hover {
            background-color: #059669;
        }

        .code-editor-content {
            flex: 1;
            display: flex;
            overflow: hidden;
        }

        .code-editor-sidebar {
            width: 200px;
            background-color: var(--surface-elevated);
            border-right: 1px solid var(--border);
            padding: 1rem;
            overflow-y: auto;
        }

        .code-editor-main {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .code-editor-tabs {
            display: flex;
            background-color: var(--surface-elevated);
            border-bottom: 1px solid var(--border);
        }

        .code-editor-tab {
            padding: 0.5rem 1rem;
            font-size: 0.875rem;
            color: var(--text-secondary);
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: var(--transition);
        }

        .code-editor-tab.active {
            color: var(--text-primary);
            border-bottom-color: var(--primary);
        }

        .code-editor-tab:hover {
            color: var(--text-primary);
        }

        .code-editor-workspace {
            flex: 1;
            display: flex;
            overflow: hidden;
        }

        .code-editor-monaco {
            flex: 1;
            height: 100%;
        }

        .code-editor-output {
            width: 40%;
            background-color: var(--surface-elevated);
            border-left: 1px solid var(--border);
            padding: 1rem;
            overflow-y: auto;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.875rem;
            color: var(--code-text);
        }

        .code-editor-output-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 0.75rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid var(--border);
        }

        .code-editor-output-title {
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .code-editor-output-content {
            white-space: pre-wrap;
            word-break: break-word;
        }

        /* Enhanced Chat Input */
        .chat-input-container {
            padding: 1.5rem;
            background-color: var(--surface);
            border-top: 1px solid var(--border);
            position: relative;
            z-index: 5;
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            width: 100%;
            z-index: 100;
        }

        .chat-input-wrapper {
            background-color: var(--surface-elevated);
            border: 1px solid var(--border);
            border-radius: var(--radius-lg);
            padding: 1rem 1.25rem;
            display: flex;
            align-items: flex-end;
            gap: 0.75rem;
            transition: var(--transition);
            box-shadow: var(--shadow);
        }

        .chat-input-wrapper:focus-within {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }

        .chat-input {
            flex: 1;
            background: none;
            border: none;
            color: var(--text-primary);
            font-size: 1rem;
            resize: none;
            outline: none;
            max-height: 200px;
            line-height: 1.5;
            font-family: inherit;
            font-size: 16px;
        }

        .chat-input::placeholder {
            color: var(--text-tertiary);
        }

        .chat-actions {
            display: flex;
            gap: 0.5rem;
        }

        .chat-action-btn {
            width: 40px;
            height: 40px;
            border-radius: var(--radius);
            background-color: transparent;
            border: none;
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: var(--transition);
        }

        .chat-action-btn:hover {
            background-color: var(--surface-highlight);
            color: var(--text-primary);
        }

        .chat-send-btn {
            width: 40px;
            height: 40px;
            border-radius: var(--radius);
            background: var(--gradient-primary);
            border: none;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: var(--transition);
        }

        .chat-send-btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .chat-send-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        /* Code Block Styles */
        .code-block {
            margin-top: 1rem;
            border-radius: var(--radius);
            overflow: hidden;
            background-color: var(--code-bg);
            border: 1px solid var(--code-border);
        }

        .code-header {
            background-color: var(--surface-highlight);
            padding: 0.5rem 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.875rem;
            color: var(--text-secondary);
            border-bottom: 1px solid var(--code-border);
        }

        .code-language {
            font-weight: 600;
            text-transform: uppercase;
            color: var(--text-primary);
        }

        .code-actions {
            display: flex;
            gap: 0.5rem;
        }

        .copy-btn, .preview-btn, .run-btn, .edit-btn {
            background-color: var(--surface-elevated);
            border: 1px solid var(--border);
            color: var(--text-primary);
            padding: 0.25rem 0.5rem;
            border-radius: var(--radius-sm);
            cursor: pointer;
            font-size: 0.75rem;
            display: flex;
            align-items: center;
            gap: 0.25rem;
            transition: all 0.2s;
        }

        .copy-btn:hover, .preview-btn:hover, .run-btn:hover, .edit-btn:hover {
            background-color: var(--surface-highlight);
            color: var(--text-primary);
        }

        .copy-btn.copied {
            background-color: var(--success);
            color: white;
            border-color: var(--success);
        }

        .run-btn {
            background-color: var(--success);
            color: white;
            border-color: var(--success);
        }

        .run-btn:hover {
            background-color: #059669;
        }

        /* Typing Effect */
        .typing-text {
            overflow: hidden;
            white-space: pre-wrap;
        }

        /* Settings Panel - Enhanced */
        .settings-panel {
            position: fixed;
            right: -400px;
            top: 0;
            width: 400px;
            height: 100vh;
            background-color: var(--surface);
            border-left: 1px solid var(--border);
            box-shadow: var(--shadow-lg);
            z-index: 100;
            display: flex;
            flex-direction: column;
            transition: right 0.3s ease;
        }

        .settings-panel.active {
            right: 0;
        }

        .settings-header {
            padding: 1.5rem;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .settings-title {
            font-family: 'Space Grotesk', sans-serif;
            font-size: 1.125rem;
            font-weight: 600;
            background: var(--gradient-primary);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            text-transform: uppercase;
        }

        .settings-close {
            width: 36px;
            height: 36px;
            border-radius: var(--radius);
            background-color: transparent;
            border: none;
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: var(--transition);
        }

        .settings-close:hover {
            background-color: var(--surface-highlight);
            color: var(--text-primary);
        }

        .settings-content {
            flex: 1;
            overflow-y: auto;
            padding: 1.5rem;
        }

        .settings-section {
            margin-bottom: 2rem;
        }

        .settings-section-title {
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--text-secondary);
            margin-bottom: 1rem;
            text-transform: uppercase;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: var(--text-primary);
        }

        .form-input {
            width: 100%;
            background-color: var(--surface-elevated);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 0.75rem;
            color: var(--text-primary);
            font-size: 1rem;
            outline: none;
            transition: border-color 0.2s;
        }

        .form-input:focus {
            border-color: var(--primary);
        }

        .form-text {
            font-size: 0.875rem;
            color: var(--text-tertiary);
            margin-top: 0.25rem;
        }

        .settings-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.75rem 0;
            border-bottom: 1px solid var(--border);
        }

        .settings-item:last-child {
            border-bottom: none;
        }

        .settings-label {
            font-weight: 500;
        }

        .settings-description {
            font-size: 0.75rem;
            color: var(--text-tertiary);
            margin-top: 0.25rem;
        }

        .settings-toggle {
            position: relative;
            width: 48px;
            height: 24px;
            background-color: var(--surface-highlight);
            border-radius: 12px;
            cursor: pointer;
            transition: var(--transition);
        }

        .settings-toggle.active {
            background-color: var(--primary);
        }

        .settings-toggle-slider {
            position: absolute;
            top: 2px;
            left: 2px;
            width: 20px;
            height: 20px;
            background-color: white;
            border-radius: 50%;
            transition: var(--transition);
        }

        .settings-toggle.active .settings-toggle-slider {
            transform: translateX(24px);
        }

        .settings-select {
            background-color: var(--surface-elevated);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            color: var(--text-primary);
            padding: 0.5rem;
            width: 120px;
            cursor: pointer;
        }

        .settings-select:focus {
            outline: none;
            border-color: var(--primary);
        }

        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 1rem;
            margin-top: 1.5rem;
        }

        .btn {
            padding: 0.75rem 1.5rem;
            border-radius: var(--radius);
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            border: none;
        }

        .btn-primary {
            background-color: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background-color: var(--primary-dark);
        }

        .btn-secondary {
            background-color: transparent;
            color: var(--text-primary);
            border: 1px solid var(--border);
        }

        .btn-secondary:hover {
            background-color: var(--surface-highlight);
        }

        .btn-danger {
            background-color: var(--error);
            color: white;
        }

        .btn-danger:hover {
            background-color: #dc2626;
        }

        /* User Profile Panel - Enhanced */
        .user-profile-panel {
            position: fixed;
            left: -300px;
            top: 0;
            width: 300px;
            height: 100vh;
            background-color: var(--surface);
            border-right: 1px solid var(--border);
            box-shadow: var(--shadow-lg);
            z-index: 100;
            display: flex;
            flex-direction: column;
            transition: left 0.3s ease;
        }

        .user-profile-panel.active {
            left: 0;
        }

        .user-profile-header {
            padding: 1.5rem;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .user-profile-title {
            font-family: 'Space Grotesk', sans-serif;
            font-size: 1.125rem;
            font-weight: 600;
            background: var(--gradient-primary);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            text-transform: uppercase;
        }

        .user-profile-close {
            width: 36px;
            height: 36px;
            border-radius: var(--radius);
            background-color: transparent;
            border: none;
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: var(--transition);
        }

        .user-profile-close:hover {
            background-color: var(--surface-highlight);
            color: var(--text-primary);
        }

        .user-profile-content {
            flex: 1;
            overflow-y: auto;
            padding: 1.5rem;
        }

        .user-profile-avatar-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-bottom: 2rem;
        }

        .user-profile-avatar {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: var(--gradient-primary);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 2rem;
            margin-bottom: 1rem;
        }

        .user-profile-name {
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 0.25rem;
            background: var(--gradient-primary);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .user-profile-email {
            font-size: 0.875rem;
            color: var(--text-secondary);
        }

        .user-profile-section {
            margin-bottom: 2rem;
        }

        .user-profile-section-title {
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--text-secondary);
            margin-bottom: 1rem;
            text-transform: uppercase;
        }

        .user-profile-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.75rem 0;
            border-bottom: 1px solid var(--border);
        }

        .user-profile-item:last-child {
            border-bottom: none;
        }

        .user-profile-label {
            font-weight: 500;
        }

        .user-profile-value {
            font-size: 0.875rem;
            color: var(--text-secondary);
        }

        /* Toast Notifications - Enhanced */
        .toast-container {
            position: fixed;
            bottom: 1.5rem;
            right: 1.5rem;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .toast {
            background-color: var(--surface-elevated);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 1rem 1.25rem;
            box-shadow: var(--shadow-lg);
            display: flex;
            align-items: center;
            gap: 0.75rem;
            min-width: 300px;
            animation: slideIn 0.3s ease, slideOut 0.3s ease 2.7s forwards;
            opacity: 0;
            transform: translateX(100%);
        }

        @keyframes slideIn {
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        @keyframes slideOut {
            to {
                opacity: 0;
                transform: translateX(100%);
            }
        }

        .toast-icon {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .toast.success .toast-icon {
            background-color: var(--success);
            color: white;
        }

        .toast.error .toast-icon {
            background-color: var(--error);
            color: white;
        }

        .toast.warning .toast-icon {
            background-color: var(--warning);
            color: white;
        }

        .toast-message {
            flex: 1;
        }

        .toast-title {
            font-weight: 500;
            margin-bottom: 0.25rem;
        }

        .toast-description {
            font-size: 0.875rem;
            color: var(--text-tertiary);
        }

        /* Confirmation Modal - Enhanced */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            display: none;
            align-items: center;
            justify-content: center;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal {
            background-color: var(--surface);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-lg);
            padding: 1.5rem;
            width: 90%;
            max-width: 400px;
            border: 1px solid var(--border);
        }

        .modal-header {
            margin-bottom: 1rem;
        }

        .modal-title {
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .modal-description {
            color: var(--text-secondary);
            margin-bottom: 1.5rem;
        }

        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 1rem;
        }

        /* Search Modal - Enhanced */
        .search-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            display: none;
            align-items: flex-start;
            justify-content: center;
            padding-top: 10vh;
        }

        .search-modal.active {
            display: flex;
        }

        .search-container {
            background-color: var(--surface);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-lg);
            width: 90%;
            max-width: 600px;
            border: 1px solid var(--border);
            overflow: hidden;
        }

        .search-header {
            padding: 1rem;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .search-input {
            flex: 1;
            background-color: var(--surface-elevated);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 0.5rem 0.75rem;
            color: var(--text-primary);
            font-size: 1rem;
            outline: none;
        }

        .search-results {
            max-height: 50vh;
            overflow-y: auto;
        }

        .search-result-item {
            padding: 1rem;
            border-bottom: 1px solid var(--border);
            cursor: pointer;
            transition: var(--transition);
        }

        .search-result-item:hover {
            background-color: var(--surface-highlight);
        }

        .search-result-item:last-child {
            border-bottom: none;
        }

        .search-result-title {
            font-weight: 500;
            margin-bottom: 0.25rem;
        }

        .search-result-preview {
            font-size: 0.875rem;
            color: var(--text-secondary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .search-result-date {
            font-size: 0.75rem;
            color: var(--text-tertiary);
            margin-top: 0.25rem;
        }

        /* Rename Modal - Enhanced */
        .rename-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            display: none;
            align-items: center;
            justify-content: center;
        }

        .rename-modal.active {
            display: flex;
        }

        /* Chat History Features - Enhanced */
        .chat-history-features {
            padding: 0.75rem;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.75rem;
        }

        .chat-history-filter {
            display: flex;
            gap: 0.5rem;
        }

        .filter-btn {
            padding: 0.25rem 0.5rem;
            border-radius: var(--radius-sm);
            background-color: transparent;
            border: 1px solid var(--border);
            color: var(--text-secondary);
            font-size: 0.75rem;
            cursor: pointer;
            transition: var(--transition);
        }

        .filter-btn:hover {
            background-color: var(--surface-highlight);
            color: var(--text-primary);
        }

        .filter-btn.active {
            background-color: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        .chat-history-sort {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .sort-btn {
            padding: 0.25rem 0.5rem;
            border-radius: var(--radius-sm);
            background-color: transparent;
            border: 1px solid var(--border);
            color: var(--text-secondary);
            font-size: 0.75rem;
            cursor: pointer;
            transition: var(--transition);
        }

        .sort-btn:hover {
            background-color: var(--surface-highlight);
            color: var(--text-primary);
        }

        /* Mobile Responsiveness - Enhanced */
        @media (max-width: 768px) {
            .app-container {
                flex-direction: column;
                height: 100vh;
                overflow: hidden;
            }
            
            .sidebar {
                width: 100%;
                height: 100%;
                position: fixed;
                left: -100%;
                top: 0;
                z-index: 100;
                transition: left 0.3s ease;
            }
            
            .sidebar.active {
                left: 0;
            }
            
            .main-content {
                flex: 1;
                display: flex;
                flex-direction: column;
                overflow: hidden;
                height: 100vh;
            }
            
            .chat-container {
                flex: 1;
                display: flex;
                flex-direction: column;
                overflow: hidden;
                height: calc(100vh - 70px);
            }
            
            .chat-messages {
                flex: 1;
                overflow-y: auto;
                padding: 1rem;
                padding-bottom: 100px;
                -webkit-overflow-scrolling: touch;
            }
            
            .chat-input-container {
                position: fixed;
                bottom: 0;
                left: 0;
                right: 0;
                background-color: var(--surface);
                border-top: 1px solid var(--border);
                padding: 1rem;
                z-index: 10;
                box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
            }
            
            .chat-input-wrapper {
                display: flex;
                align-items: center;
                gap: 0.75rem;
                background-color: var(--surface-elevated);
                border: 1px solid var(--border);
                border-radius: var(--radius-lg);
                padding: 0.75rem;
            }
            
            .chat-input {
                flex: 1;
                border: none;
                background: transparent;
                color: var(--text-primary);
                font-size: 16px;
                outline: none;
                resize: none;
                max-height: 120px;
            }
            
            .chat-send-btn {
                width: 44px;
                height: 44px;
                border-radius: 50%;
                background: var(--gradient-primary);
                border: none;
                color: white;
                display: flex;
                align-items: center;
                justify-content: center;
                cursor: pointer;
                flex-shrink: 0;
            }
            
            .message {
                max-width: 90%;
            }
            
            .message-content {
                padding: 0.75rem 1rem;
                font-size: 0.95rem;
            }
            
            .code-block {
                margin: 1rem -1rem;
                border-radius: 0;
                border-left: none;
                border-right: none;
            }
            
            .code-header {
                border-radius: 0;
                border-left: none;
                border-right: none;
            }
            
            pre {
                border-radius: 0;
                margin: 0;
                max-height: 250px;
                overflow-x: auto;
            }
            
            .chat-messages {
                scroll-behavior: smooth;
            }
            
            .keyboard-open .chat-messages {
                height: calc(100vh - 300px);
            }
            
            .keyboard-open .chat-input-container {
                padding-bottom: env(safe-area-inset-bottom, 20px);
            }
            
            .mobile-menu-btn {
                display: block;
            }
            
            .settings-panel {
                width: 100%;
                right: -100%;
            }
            
            .user-profile-panel {
                width: 100%;
                left: -100%;
            }
            
            .toast-container {
                left: 1.5rem;
                right: 1.5rem;
            }
            
            .toast {
                min-width: auto;
            }
            
            .chat-messages {
                padding: 1rem;
                padding-bottom: 3rem;
            }
            
            .chat-input-container {
                padding: 0.75rem;
                position: fixed;
                bottom: 0;
                left: 0;
                right: 0;
                background-color: var(--surface);
                border-top: 1px solid var(--border);
                z-index: 10;
                width: 100%;
            }
            
            .header {
                padding: 0 1rem;
            }
            
            .header-title {
                font-size: 1rem;
            }
            
            .message-content {
                padding: 0.75rem 1rem;
                font-size: 0.95rem;
            }
            
            .code-header {
                padding: 0.4rem 0.8rem;
                font-size: 0.8rem;
            }
            
            .copy-btn, .preview-btn, .run-btn, .edit-btn {
                padding: 0.2rem 0.4rem;
                font-size: 0.7rem;
            }
            
            .chat-container {
                height: calc(100vh - 70px);
                display: flex;
                flex-direction: column;
            }
            
            .chat-messages {
                height: calc(100% - 100px);
                overflow-y: auto;
            }
            
            .chat-send-btn {
                width: 40px;
                height: 40px;
            }
            
            .header-btn, .chat-action-btn, .message-action-btn {
                width: 40px;
                height: 40px;
            }
            
            .chat-input-wrapper {
                padding: 0.75rem;
                width: 100%;
            }
            
            .chat-messages {
                -webkit-overflow-scrolling: touch;
            }
            
            .preview-btn {
                padding: 0.3rem 0.6rem;
            }
            
            .mobile-code-block {
                margin: 0.75rem -1rem;
                border-radius: 0;
                border-left: none;
                border-right: none;
            }
            
            .mobile-code-block .code-header {
                border-radius: 0;
                border-left: none;
                border-right: none;
            }
            
            .mobile-code-block pre {
                border-radius: 0;
                border-left: none;
                border-right: none;
                margin: 0;
                max-height: 250px;
            }
            
            .modal {
                width: 95%;
                max-width: none;
            }
            
            .search-container {
                width: 95%;
                max-width: none;
            }
            
            .chat-input {
                font-size: 16px;
            }
            
            .chat-input-wrapper {
                border-radius: var(--radius-lg);
                border-left: none;
                border-right: none;
            }
            
            .chat-item {
                padding: 1rem;
            }
            
            .chat-item-icon {
                width: 36px;
                height: 36px;
            }
            
            .chat-item.active .chat-item-title {
                font-weight: 600;
            }
            
            .chat-item {
                padding: 1rem;
            }

            .chat-item-icon {
                width: 40px;
                height: 40px;
                font-size: 1.2rem;
            }

            .chat-item-title {
                font-size: 1rem;
                font-weight: 500;
            }

            .chat-item-date {
                font-size: 0.8rem;
            }

            .chat-item-actions {
                opacity: 1;
            }

            .chat-item-action-btn {
                width: 32px;
                height: 32px;
                font-size: 1rem;
            }
            
            .chat-item {
                min-height: 60px;
            }
            
            .chat-history {
                -webkit-overflow-scrolling: touch;
                scroll-behavior: smooth;
            }
            
            .chat-group-header {
                padding: 0.75rem 1rem;
                font-size: 0.875rem;
                font-weight: 700;
                background-color: var(--surface-elevated);
                border-bottom: 1px solid var(--border);
            }
        }

        /* Loading Spinner - Enhanced */
        .spinner {
            width: 20px;
            height: 20px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        /* Custom Scrollbar - Enhanced */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--surface);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--surface-elevated);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--surface-highlight);
        }

        /* Overlay - Enhanced */
        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 15;
            display: none;
        }

        .overlay.active {
            display: block;
        }
        
        /* Brand styling - Enhanced */
        .brand-nexariq {
            font-family: 'Space Grotesk', sans-serif;
            font-weight: 700;
            text-transform: uppercase;
            background: var(--gradient-primary);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .brand-lynxa {
            font-family: 'Space Grotesk', sans-serif;
            font-weight: 700;
            text-transform: uppercase;
            background: var(--gradient-accent);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        /* User name styling with colorful gradient - Enhanced */
        .user-name-colorful {
            font-weight: 600;
            background: var(--gradient-accent);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            display: inline;
        }
        
        /* Mobile keyboard adjustments - Enhanced */
        @media (max-width: 768px) and (orientation: portrait) {
            .keyboard-open .chat-messages {
                height: calc(100% - 180px);
            }
        }
        
        /* Enhanced Code Editor Styles */
        .code-editor-container {
            margin: 1rem 0;
            border-radius: var(--radius-lg);
            overflow: hidden;
            box-shadow: var(--shadow-lg);
            border: 1px solid var(--border);
        }

        .code-editor-tabs {
            display: flex;
            background-color: var(--surface-elevated);
            border-bottom: 1px solid var(--border);
        }

        .code-editor-tab {
            padding: 0.75rem 1.5rem;
            font-size: 0.875rem;
            color: var(--text-secondary);
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: var(--transition);
            font-weight: 500;
        }

        .code-editor-tab.active {
            color: var(--text-primary);
            border-bottom-color: var(--primary);
        }

        .code-editor-tab:hover {
            color: var(--text-primary);
        }

        .code-editor-workspace {
            display: flex;
            height: 400px;
        }

        .code-editor-monaco {
            flex: 1;
            height: 100%;
        }

        .code-editor-output {
            width: 40%;
            background-color: var(--surface-elevated);
            border-left: 1px solid var(--border);
            padding: 1rem;
            overflow-y: auto;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.875rem;
            color: var(--code-text);
        }

        .code-editor-output-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 0.75rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid var(--border);
        }

        .code-editor-output-title {
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .code-editor-output-content {
            white-space: pre-wrap;
            word-break: break-word;
        }

        /* Enhanced Floating Action Button */
        .floating-action-btn {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: var(--gradient-primary);
            color: white;
            border: none;
            box-shadow: var(--shadow-lg);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: var(--transition);
            z-index: 50;
        }

        .floating-action-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 8px 16px rgba(99, 102, 241, 0.4);
        }

        /* Enhanced Animation Classes */
        .fade-in {
            animation: fadeIn 0.3s ease;
        }

        .slide-in-up {
            animation: slideInUp 0.3s ease;
        }

        .slide-in-down {
            animation: slideInDown 0.3s ease;
        }

        .slide-in-left {
            animation: slideInLeft 0.3s ease;
        }

        .slide-in-right {
            animation: slideInRight 0.3s ease;
        }

        @keyframes slideInUp {
            from {
                transform: translateY(20px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        @keyframes slideInDown {
            from {
                transform: translateY(-20px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        @keyframes slideInLeft {
            from {
                transform: translateX(-20px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes slideInRight {
            from {
                transform: translateX(20px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        /* Enhanced Glow Effects */
        .glow-primary {
            box-shadow: var(--glow-primary);
        }

        .glow-secondary {
            box-shadow: var(--glow-secondary);
        }

        .glow-accent {
            box-shadow: var(--glow-accent);
        }

        /* Enhanced Code Block Styles */
        .enhanced-code-block {
            margin: 1rem 0;
            border-radius: var(--radius-lg);
            overflow: hidden;
            background-color: var(--code-bg);
            border: 1px solid var(--code-border);
            box-shadow: var(--shadow);
        }

        .enhanced-code-header {
            background-color: var(--surface-highlight);
            padding: 0.75rem 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.875rem;
            color: var(--text-secondary);
            border-bottom: 1px solid var(--code-border);
        }

        .enhanced-code-language {
            font-weight: 600;
            text-transform: uppercase;
            color: var(--text-primary);
        }

        .enhanced-code-actions {
            display: flex;
            gap: 0.5rem;
        }

        .enhanced-code-content {
            padding: 1rem;
            overflow-x: auto;
        }

        .enhanced-code-content pre {
            margin: 0;
            padding: 0;
            background: none;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.875rem;
            color: var(--code-text);
            line-height: 1.5;
        }

        /* Enhanced Input Styles */
        .enhanced-input {
            width: 100%;
            background-color: var(--surface-elevated);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 0.75rem 1rem;
            color: var(--text-primary);
            font-size: 1rem;
            outline: none;
            transition: var(--transition);
        }

        .enhanced-input:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }

        /* Enhanced Button Styles */
        .enhanced-btn {
            padding: 0.75rem 1.5rem;
            border-radius: var(--radius);
            font-weight: 500;
            cursor: pointer;
            transition: var(--transition);
            border: none;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        .enhanced-btn-primary {
            background: var(--gradient-primary);
            color: white;
        }

        .enhanced-btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .enhanced-btn-secondary {
            background-color: transparent;
            color: var(--text-primary);
            border: 1px solid var(--border);
        }

        .enhanced-btn-secondary:hover {
            background-color: var(--surface-highlight);
        }

        /* Enhanced Card Styles */
        .enhanced-card {
            background-color: var(--surface);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            transition: var(--transition);
        }

        .enhanced-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .enhanced-card-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 1rem;
            padding-bottom: 0.75rem;
            border-bottom: 1px solid var(--border);
        }

        .enhanced-card-title {
            font-size: 1.125rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .enhanced-card-content {
            color: var(--text-secondary);
        }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div class="login-screen" id="loginScreen">
        <div class="container" id="loginContainer">
            <div class="curved-shape"></div>
            <div class="curved-shape2"></div>
            
            <!-- Login Form -->
            <div class="form-box Login">
                <div class="brand-container animation" style="--D:0; --S:20">
                    <img src="https://z-cdn-media.chatglm.cn/files/1d46b5c3-4a2c-43e0-8129-a67c7ca4c80b_pasted_image_1759040841309.jpg?auth_key=1790577586-d5291ba80bda4631918430ba65a8f682-0-c874bd93ec0e0b7077d1d0c132d27af3" alt="Nexariq Logo" class="brand-logo">
                    <h1 class="brand-name">Nexariq AI</h1>
                </div>
                
                <h2 class="animation" style="--D:0; --S:21">Login</h2>
                
                <form id="loginForm">
                    <div class="input-box animation" style="--D:1; --S:22">
                        <input type="email" id="loginEmail" required>
                        <label for="loginEmail">Email</label>
                        <i class='bx bx-envelope'></i>
                    </div>

                    <div class="input-box animation" style="--D:2; --S:23">
                        <input type="password" id="loginPassword" required>
                        <label for="loginPassword">Password</label>
                        <i class='bx bx-lock-alt'></i>
                    </div>

                    <div class="input-box animation" style="--D:3; --S:24">
                        <button type="submit" class="btn" id="loginBtn">Login</button>
                    </div>
                    
                    <div class="divider animation" style="--D:4; --S:25">
                        <span>OR</span>
                    </div>
                    
                    <div class="input-box animation" style="--D:5; --S:26">
                        <a href="#" class="google-btn" id="googleSignInBtn">
                            <i class='bx bxl-google'></i>
                            Login with Google
                        </a>
                    </div>

                    <div class="regi-link animation" style="--D:6; --S:27">
                        <p>Don't have an account? <a href="#" class="SignUpLink">Sign Up</a></p>
                    </div>
                </form>
                
                <div class="login-error" id="loginError"></div>
                <div class="login-success" id="loginSuccess"></div>
            </div>

            <!-- Login Info -->
            <div class="info-content Login">
                <h2 class="animation" style="--D:0; --S:20">WELCOME BACK!</h2>
                <p class="animation" style="--D:1; --S:21">We are happy to have you with us again. If you need anything, we are here to help.</p>
            </div>

            <!-- Register Form -->
            <div class="form-box Register">
                <div class="brand-container animation" style="--li:17; --S:0">
                    <img src="https://z-cdn-media.chatglm.cn/files/1d46b5c3-4a2c-43e0-8129-a67c7ca4c80b_pasted_image_1759040841309.jpg?auth_key=1790577586-d5291ba80bda4631918430ba65a8f682-0-c874bd93ec0e0b7077d1d0c132d27af3" alt="Nexariq Logo" class="brand-logo">
                    <h1 class="brand-name">Nexariq AI</h1>
                </div>
                
                <h2 class="animation" style="--li:17; --S:0">Register</h2>
                
                <form id="registerForm">
                    <div class="input-box animation" style="--li:18; --S:1">
                        <input type="text" id="registerName" required>
                        <label for="registerName">Name</label>
                        <i class='bx bx-user'></i>
                    </div>

                    <div class="input-box animation" style="--li:19; --S:2">
                        <input type="email" id="registerEmail" required>
                        <label for="registerEmail">Email</label>
                        <i class='bx bx-envelope'></i>
                    </div>

                    <div class="input-box animation" style="--li:19; --S:3">
                        <input type="password" id="registerPassword" required>
                        <label for="registerPassword">Password</label>
                        <i class='bx bx-lock-alt'></i>
                    </div>

                    <div class="input-box animation" style="--li:20; --S:4">
                        <button type="submit" class="btn" id="registerBtn">Register</button>
                    </div>
                    
                    <div class="divider animation" style="--li:21; --S:5">
                        <span>OR</span>
                    </div>
                    
                    <div class="input-box animation" style="--li:22; --S:6">
                        <a href="#" class="google-btn" id="googleSignUpBtn">
                            <i class='bx bxl-google'></i>
                            Sign up with Google
                        </a>
                    </div>

                    <div class="regi-link animation" style="--li:23; --S:7">
                        <p>Already have an account? <a href="#" class="SignInLink">Sign In</a></p>
                    </div>
                </form>
                
                <div class="login-error" id="registerError"></div>
                <div class="login-success" id="registerSuccess"></div>
            </div>

            <!-- Register Info -->
            <div class="info-content Register">
                <h2 class="animation" style="--li:17; --S:0">WELCOME!</h2>
                <p class="animation" style="--li:18; --S:1">We're delighted to have you here. If you need any assistance, feel free to reach out.</p>
            </div>
        </div>
    </div>

    <div class="app-container hidden" id="appContainer">
        <!-- Sidebar -->
        <div class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <a href="#" class="logo">
                    <!-- Nexariq Logo Image -->
                    <img src="https://z-cdn-media.chatglm.cn/files/1d46b5c3-4a2c-43e0-8129-a67c7ca4c80b_pasted_image_1759040841309.jpg?auth_key=1790577586-d5291ba80bda4631918430ba65a8f682-0-c874bd93ec0e0b7077d1d0c132d27af3" alt="Nexariq" class="logo-img">
                    <span class="logo-text">Nexariq AI</span>
                </a>
                <button class="new-chat-btn" id="newChatBtn">
                    <i class="fas fa-plus"></i>
                    <span>New Chat</span>
                </button>
            </div>
            <div class="chat-history">
                <div class="chat-history-features">
                    <div class="chat-history-filter">
                        <button class="filter-btn active" data-filter="all">All</button>
                        <button class="filter-btn" data-filter="pinned">Pinned</button>
                        <button class="filter-btn" data-filter="recent">Recent</button>
                    </div>
                    <div class="chat-history-sort">
                        <button class="sort-btn" id="sortChatsBtn" title="Sort chats">
                            <i class="fas fa-sort"></i>
                        </button>
                    </div>
                </div>
                <div class="chat-history-header">
                    <div class="chat-history-title">Recent Chats</div>
                    <div class="chat-history-actions">
                        <button class="chat-history-action-btn" id="searchChatBtn" title="Search chats">
                            <i class="fas fa-search"></i>
                        </button>
                        <button class="chat-history-action-btn" id="exportChatBtn" title="Export chats">
                            <i class="fas fa-download"></i>
                        </button>
                        <button class="chat-history-action-btn" id="clearChatBtn" title="Clear all chats">
                            <i class="fas fa-trash-alt"></i>
                        </button>
                    </div>
                </div>
                <div id="chatHistory">
                    <div class="chat-item active" data-chat-id="current">
                        <div class="chat-item-icon">
                            <i class="fas fa-code"></i>
                        </div>
                        <div class="chat-item-content">
                            <div class="chat-item-title">Current Session</div>
                            <div class="chat-item-date">Just now</div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="sidebar-footer">
                <div class="user-menu" id="userMenu">
                    <div class="user-avatar" id="userAvatar">U</div>
                    <div class="user-info">
                        <div class="user-name" id="userName">User Name</div>
                        <div class="user-email" id="userEmail">user@example.com</div>
                    </div>
                    <i class="fas fa-chevron-up"></i>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Header -->
            <div class="header">
                <div class="header-left">
                    <button class="mobile-menu-btn" id="mobileMenuBtn">
                        <i class="fas fa-bars"></i>
                    </button>
                    <button class="mobile-back-btn" id="mobileBackBtn">
                        <i class="fas fa-arrow-left"></i>
                    </button>
                    <div class="header-title">Nexariq AI - Code Assistant</div>
                </div>
                <div class="header-actions">
                    <button class="header-btn" id="themeToggleBtn" title="Toggle Theme">
                        <i class="fas fa-moon"></i>
                    </button>
                    <button class="header-btn" id="settingsBtn" title="Settings">
                        <i class="fas fa-cog"></i>
                    </button>
                    <button class="header-btn" id="signOutBtn" title="Sign Out">
                        <i class="fas fa-sign-out-alt"></i>
                    </button>
                </div>
            </div>

            <!-- Chat Container -->
            <div class="chat-container">
                <div class="chat-messages" id="chatMessages">
                    <div class="message ai">
                        <div class="message-avatar">
                            <!-- AI Avatar Image -->
                            <img src="https://z-cdn-media.chatglm.cn/files/9e95cdab-fb04-4e3e-9707-3a1a42cf4af2_pasted_image_1759042616103.jpg?auth_key=1790578672-8ce8bef12666447cab9411207f3410af-0-15fac8a4b233794ce2b1a852cd1a5d56" alt="Lynxa Pro" class="message-avatar-img">
                        </div>
                        <div class="message-content">
                            <div class="message-text">
                                <h2>Hello! I'm <span class="brand-lynxa">Lynxa Pro</span></h2>
                                <p>I'm an advanced AI code assistant developed by <span class="brand-nexariq">Nexariq (AJ STUDIOZ)</span>. I specialize in helping with coding tasks and can execute code in multiple languages.</p>
                                
                                <div class="info-box">
                                    <div class="info-box-title">My Coding Capabilities</div>
                                    <ul>
                                        <li>Writing and debugging code in multiple languages</li>
                                        <li>Explaining algorithms and data structures</li>
                                        <li>Optimizing code for performance</li>
                                        <li>Converting between programming languages</li>
                                        <li>Creating APIs and web applications</li>
                                        <li>Database design and queries</li>
                                        <li>Code review and best practices</li>
                                    </ul>
                                </div>
                                
                                <p>I have access to a powerful code execution environment and can help you with everything from simple scripts to complex applications.</p>
                                
                                <blockquote>
                                    <strong>Interactive Coding:</strong> Try sending me a code snippet, and I can run it for you or explain how it works!
                                </blockquote>
                            </div>
                            <div class="message-actions">
                                <button class="message-action-btn" title="Copy" onclick="copyMessage('welcome-message')">
                                    <i class="fas fa-copy"></i>
                                    <span class="tooltip">Copy</span>
                                </button>
                                <button class="message-action-btn" title="Good response" onclick="likeMessage('welcome-message')">
                                    <i class="fas fa-thumbs-up"></i>
                                    <span class="tooltip">Good response</span>
                                </button>
                                <button class="message-action-btn" title="Bad response" onclick="dislikeMessage('welcome-message')">
                                    <i class="fas fa-thumbs-down"></i>
                                    <span class="tooltip">Bad response</span>
                                </button>
                            </div>
                            <div class="message-time">Just now</div>
                        </div>
                    </div>
                </div>

                <!-- Enhanced Code Editor Container -->
                <div class="code-editor-container">
                    <div class="code-editor-header">
                        <div class="code-editor-title">
                            <i class="fas fa-code"></i>
                            <span>Code Editor</span>
                        </div>
                        <div class="code-editor-actions">
                            <button class="code-editor-btn" id="codeFormatBtn" title="Format Code">
                                <i class="fas fa-magic"></i>
                            </button>
                            <button class="code-editor-btn" id="codeLanguageBtn" title="Change Language">
                                <i class="fas fa-language"></i>
                            </button>
                            <button class="code-editor-btn run" id="codeRunBtn" title="Run Code">
                                <i class="fas fa-play"></i>
                            </button>
                            <button class="code-editor-btn" id="codeShareBtn" title="Share Code">
                                <i class="fas fa-share"></i>
                            </button>
                        </div>
                    </div>
                    <div class="code-editor-content">
                        <div class="code-editor-tabs">
                            <div class="code-editor-tab active" data-language="javascript">JavaScript</div>
                            <div class="code-editor-tab" data-language="python">Python</div>
                            <div class="code-editor-tab" data-language="html">HTML</div>
                            <div class="code-editor-tab" data-language="css">CSS</div>
                            <div class="code-editor-tab" data-language="sql">SQL</div>
                        </div>
                        <div class="code-editor-workspace">
                            <div id="monacoEditor" class="code-editor-monaco"></div>
                            <div class="code-editor-output">
                                <div class="code-editor-output-header">
                                    <div class="code-editor-output-title">Output</div>
                                    <button class="code-editor-btn" id="clearOutputBtn" title="Clear Output">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                                <div class="code-editor-output-content" id="codeOutput">
                                    <div class="info-box">
                                        <div class="info-box-title">Ready to run code</div>
                                        <p>Write or paste your code in the editor and click the Run button to execute it.</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Enhanced Chat Input -->
            <div class="chat-input-container">
                <div class="chat-input-wrapper">
                    <textarea class="chat-input" id="chatInput" placeholder="Ask me about coding or paste your code here..." rows="1"></textarea>
                    <div class="chat-actions">
                        <button class="chat-action-btn" id="attachBtn" title="Attach file">
                            <i class="fas fa-paperclip"></i>
                        </button>
                        <button class="chat-action-btn" id="voiceInputBtn" title="Voice input">
                            <i class="fas fa-microphone"></i>
                        </button>
                        <button class="chat-action-btn" id="codeSnippetBtn" title="Insert code snippet">
                            <i class="fas fa-code"></i>
                        </button>
                        <button class="chat-send-btn" id="sendBtn">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Settings Panel -->
    <div class="settings-panel" id="settingsPanel">
        <div class="settings-header">
            <div class="settings-title">Settings</div>
            <button class="settings-close" id="settingsClose">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="settings-content">
            <div class="settings-section">
                <div class="settings-section-title">Code Editor Preferences</div>
                <div class="form-group">
                    <label for="codeTheme" class="form-label">Editor Theme</label>
                    <select id="codeTheme" class="form-input">
                        <option value="vs-dark" selected>Dark</option>
                        <option value="vs">Light</option>
                        <option value="hc-black">High Contrast</option>
                    </select>
                    <p class="form-text">Choose the theme for the code editor</p>
                </div>
                <div class="form-group">
                    <label for="codeFontSize" class="form-label">Font Size</label>
                    <select id="codeFontSize" class="form-input">
                        <option value="12px">Small</option>
                        <option value="14px" selected>Medium</option>
                        <option value="16px">Large</option>
                    </select>
                    <p class="form-text">Adjust the font size in the code editor</p>
                </div>
                <div class="settings-item">
                    <div>
                        <div class="settings-label">Auto-format Code</div>
                        <div class="settings-description">Automatically format code when pasted</div>
                    </div>
                    <div class="settings-toggle active" id="autoFormatToggle">
                        <div class="settings-toggle-slider"></div>
                    </div>
                </div>
                <div class="settings-item">
                    <div>
                        <div class="settings-label">Line Numbers</div>
                        <div class="settings-description">Show line numbers in the editor</div>
                    </div>
                    <div class="settings-toggle active" id="lineNumbersToggle">
                        <div class="settings-toggle-slider"></div>
                    </div>
                </div>
            </div>
            
            <div class="settings-section">
                <div class="settings-section-title">Appearance</div>
                <div class="settings-item">
                    <div>
                        <div class="settings-label">Theme</div>
                        <div class="settings-description">Choose the app theme</div>
                    </div>
                    <select class="settings-select" id="themeSelect">
                        <option value="dark" selected>Dark</option>
                        <option value="light">Light</option>
                        <option value="system">System</option>
                    </select>
                </div>
                <div class="settings-item">
                    <div>
                        <div class="settings-label">Font Size</div>
                        <div class="settings-description">Adjust the font size</div>
                    </div>
                    <select class="settings-select" id="fontSizeSelect">
                        <option value="small">Small</option>
                        <option value="medium" selected>Medium</option>
                        <option value="large">Large</option>
                    </select>
                </div>
            </div>
            
            <div class="settings-section">
                <div class="settings-section-title">Features</div>
                <div class="settings-item">
                    <div>
                        <div class="settings-label">Code Execution</div>
                        <div class="settings-description">Enable code execution in the editor</div>
                    </div>
                    <div class="settings-toggle active" id="codeExecutionToggle">
                        <div class="settings-toggle-slider"></div>
                    </div>
                </div>
                <div class="settings-item">
                    <div>
                        <div class="settings-label">Auto-run Code</div>
                        <div class="settings-description">Automatically run code when pasted</div>
                    </div>
                    <div class="settings-toggle" id="autoRunToggle">
                        <div class="settings-toggle-slider"></div>
                    </div>
                </div>
                <div class="settings-item">
                    <div>
                        <div class="settings-label">Voice Input</div>
                        <div class="settings-description">Enable voice input for messages</div>
                    </div>
                    <div class="settings-toggle active" id="voiceInputToggle">
                        <div class="settings-toggle-slider"></div>
                    </div>
                </div>
            </div>
            
            <div class="modal-footer">
                <button class="btn btn-secondary" id="cancelSettingsBtn">Cancel</button>
                <button class="btn btn-primary" id="saveSettingsBtn">Save</button>
            </div>
        </div>
    </div>

    <!-- User Profile Panel -->
    <div class="user-profile-panel" id="userProfilePanel">
        <div class="user-profile-header">
            <div class="user-profile-title">User Profile</div>
            <button class="user-profile-close" id="userProfileClose">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="user-profile-content">
            <div class="user-profile-avatar-container">
                <div class="user-profile-avatar" id="userProfileAvatar">U</div>
                <div class="user-profile-name" id="userProfileName">User Name</div>
                <div class="user-profile-email" id="userProfileEmail">user@example.com</div>
            </div>
            
            <div class="user-profile-section">
                <div class="user-profile-section-title">Profile</div>
                <div class="form-group">
                    <label for="profileDisplayName" class="form-label">Display Name</label>
                    <input type="text" id="profileDisplayName" class="form-input" placeholder="Enter your name">
                </div>
            </div>
            
            <div class="user-profile-section">
                <div class="user-profile-section-title">Account Information</div>
                <div class="user-profile-item">
                    <div class="user-profile-label">User ID</div>
                    <div class="user-profile-value" id="userProfileId">Loading...</div>
                </div>
                <div class="user-profile-item">
                    <div class="user-profile-label">Provider</div>
                    <div class="user-profile-value" id="userProfileProvider">Loading...</div>
                </div>
                <div class="user-profile-item">
                    <div class="user-profile-label">Account Created</div>
                    <div class="user-profile-value" id="userProfileCreated">Loading...</div>
                </div>
                <div class="user-profile-item">
                    <div class="user-profile-label">Last Sign In</div>
                    <div class="user-profile-value" id="userProfileLastSignIn">Loading...</div>
                </div>
            </div>
            
            <div class="modal-footer">
                <button class="btn btn-secondary" id="cancelProfileBtn">Cancel</button>
                <button class="btn btn-primary" id="saveProfileBtn">Save</button>
                <button class="btn btn-primary" id="signOutFromProfileBtn">Sign Out</button>
            </div>
        </div>
    </div>

    <!-- Confirmation Modal -->
    <div class="modal-overlay" id="confirmModal">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title" id="confirmTitle">Confirm Action</div>
            </div>
            <div class="modal-description" id="confirmDescription">
                Are you sure you want to proceed with this action?
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="confirmCancelBtn">Cancel</button>
                <button class="btn btn-danger" id="confirmOkBtn">Confirm</button>
            </div>
        </div>
    </div>

    <!-- Search Modal -->
    <div class="search-modal" id="searchModal">
        <div class="search-container">
            <div class="search-header">
                <i class="fas fa-search"></i>
                <input type="text" class="search-input" id="searchInput" placeholder="Search conversations...">
                <button class="settings-close" id="searchCloseBtn">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="search-results" id="searchResults">
                <div class="search-result-item">
                    <div class="search-result-title">No results found</div>
                    <div class="search-result-preview">Try a different search term</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Rename Modal -->
    <div class="rename-modal" id="renameModal">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title">Rename Chat</div>
            </div>
            <div class="form-group">
                <input type="text" class="form-input" id="renameInput" placeholder="Enter new name">
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="renameCancelBtn">Cancel</button>
                <button class="btn btn-primary" id="renameSaveBtn">Save</button>
            </div>
        </div>
    </div>

    <!-- Overlay -->
    <div class="overlay" id="overlay"></div>

    <!-- Toast Container -->
    <div class="toast-container" id="toastContainer"></div>

    <!-- Floating Action Button -->
    <button class="floating-action-btn" id="fabBtn">
        <i class="fas fa-code"></i>
    </button>

    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyA9DeoYavkrMh8kUIwWzH01fNCaYymH4Ow",
            authDomain: "nexariq-7e82e.firebaseapp.com",
            projectId: "nexariq-7e82e",
            storageBucket: "nexariq-7e82e.firebasestorage.app",
            messagingSenderId: "1032564587257",
            appId: "1:1032564587257:web:601db80255d02988850028",
            measurementId: "G-95WKNHWNB7"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // Global state
        const state = {
            messages: [],
            chatHistory: [],
            currentChatId: null,
            isTyping: false,
            settings: {
                theme: 'dark',
                fontSize: 'medium',
                codeTheme: 'vs-dark',
                codeFontSize: '14px',
                autoFormat: true,
                lineNumbers: true,
                codeExecution: true,
                autoRun: false,
                voiceInput: true
            },
            user: null,
            authInitialized: false,
            streamingResponse: false,
            abortController: null,
            userMemory: {},
            currentView: 'chat',
            autoScroll: true,
            confirmCallback: null,
            renameChatId: null,
            userPreferences: {},
            likedMessages: new Set(),
            dislikedMessages: new Set(),
            chatFilter: 'all',
            sortDirection: 'desc',
            sortBy: 'date',
            currentChatTitle: 'Current Session',
            usersCollection: null,
            chatsCollection: null,
            currentChatDoc: null,
            // Monaco Editor
            monacoEditor: null,
            currentLanguage: 'javascript',
            codeOutput: '',
            // Voice recognition
            voiceRecognition: null,
            isRecording: false
        };

        // Typing speeds (characters per millisecond)
        const typingSpeeds = {
            slow: 100,
            medium: 60,
            fast: 30,
            instant: 0
        };

        // AI Avatar URL
        const aiAvatarUrl = 'https://z-cdn-media.chatglm.cn/files/9e95cdab-fb04-4e3e-9707-3a1a42cf4af2_pasted_image_1759042616103.jpg?auth_key=1790578672-8ce8bef12666447cab9411207f3410af-0-15fac8a4b233794ce2b1a852cd1a5d56';

        // DOM Elements
        const elements = {
            loginScreen: document.getElementById('loginScreen'),
            loginContainer: document.getElementById('loginContainer'),
            appContainer: document.getElementById('appContainer'),
            loginForm: document.getElementById('loginForm'),
            registerForm: document.getElementById('registerForm'),
            loginEmail: document.getElementById('loginEmail'),
            loginPassword: document.getElementById('loginPassword'),
            loginBtn: document.getElementById('loginBtn'),
            registerName: document.getElementById('registerName'),
            registerEmail: document.getElementById('registerEmail'),
            registerPassword: document.getElementById('registerPassword'),
            registerBtn: document.getElementById('registerBtn'),
            googleSignInBtn: document.getElementById('googleSignInBtn'),
            googleSignUpBtn: document.getElementById('googleSignUpBtn'),
            signOutBtn: document.getElementById('signOutBtn'),
            signOutFromProfileBtn: document.getElementById('signOutFromProfileBtn'),
            userAvatar: document.getElementById('userAvatar'),
            userName: document.getElementById('userName'),
            userEmail: document.getElementById('userEmail'),
            userProfilePanel: document.getElementById('userProfilePanel'),
            userProfileClose: document.getElementById('userProfileClose'),
            userProfileAvatar: document.getElementById('userProfileAvatar'),
            userProfileName: document.getElementById('userProfileName'),
            userProfileEmail: document.getElementById('userProfileEmail'),
            userProfileId: document.getElementById('userProfileId'),
            userProfileProvider: document.getElementById('userProfileProvider'),
            userProfileCreated: document.getElementById('userProfileCreated'),
            userProfileLastSignIn: document.getElementById('userProfileLastSignIn'),
            profileDisplayName: document.getElementById('profileDisplayName'),
            saveProfileBtn: document.getElementById('saveProfileBtn'),
            cancelProfileBtn: document.getElementById('cancelProfileBtn'),
            sidebar: document.getElementById('sidebar'),
            mobileMenuBtn: document.getElementById('mobileMenuBtn'),
            mobileBackBtn: document.getElementById('mobileBackBtn'),
            newChatBtn: document.getElementById('newChatBtn'),
            chatHistory: document.getElementById('chatHistory'),
            chatMessages: document.getElementById('chatMessages'),
            chatInput: document.getElementById('chatInput'),
            sendBtn: document.getElementById('sendBtn'),
            attachBtn: document.getElementById('attachBtn'),
            voiceInputBtn: document.getElementById('voiceInputBtn'),
            codeSnippetBtn: document.getElementById('codeSnippetBtn'),
            toolsBtn: document.getElementById('toolsBtn'),
            settingsBtn: document.getElementById('settingsBtn'),
            settingsPanel: document.getElementById('settingsPanel'),
            settingsClose: document.getElementById('settingsClose'),
            themeToggleBtn: document.getElementById('themeToggleBtn'),
            saveSettingsBtn: document.getElementById('saveSettingsBtn'),
            cancelSettingsBtn: document.getElementById('cancelSettingsBtn'),
            overlay: document.getElementById('overlay'),
            toastContainer: document.getElementById('toastContainer'),
            userMenu: document.getElementById('userMenu'),
            themeSelect: document.getElementById('themeSelect'),
            fontSizeSelect: document.getElementById('fontSizeSelect'),
            codeTheme: document.getElementById('codeTheme'),
            codeFontSize: document.getElementById('codeFontSize'),
            autoFormatToggle: document.getElementById('autoFormatToggle'),
            lineNumbersToggle: document.getElementById('lineNumbersToggle'),
            codeExecutionToggle: document.getElementById('codeExecutionToggle'),
            autoRunToggle: document.getElementById('autoRunToggle'),
            voiceInputToggle: document.getElementById('voiceInputToggle'),
            // Code editor elements
            codeFormatBtn: document.getElementById('codeFormatBtn'),
            codeLanguageBtn: document.getElementById('codeLanguageBtn'),
            codeRunBtn: document.getElementById('codeRunBtn'),
            codeShareBtn: document.getElementById('codeShareBtn'),
            clearOutputBtn: document.getElementById('clearOutputBtn'),
            codeOutput: document.getElementById('codeOutput'),
            // Search modal elements
            searchModal: document.getElementById('searchModal'),
            searchInput: document.getElementById('searchInput'),
            searchResults: document.getElementById('searchResults'),
            searchCloseBtn: document.getElementById('searchCloseBtn'),
            // Rename modal elements
            renameModal: document.getElementById('renameModal'),
            renameInput: document.getElementById('renameInput'),
            renameCancelBtn: document.getElementById('renameCancelBtn'),
            renameSaveBtn: document.getElementById('renameSaveBtn'),
            // Login error elements
            loginError: document.getElementById('loginError'),
            registerError: document.getElementById('registerError'),
            loginSuccess: document.getElementById('loginSuccess'),
            registerSuccess: document.getElementById('registerSuccess'),
            // FAB button
            fabBtn: document.getElementById('fabBtn')
        };

        // Initialize app
        document.addEventListener('DOMContentLoaded', () => {
            // Check for saved theme preference
            const savedTheme = localStorage.getItem('theme') || 'dark';
            state.settings.theme = savedTheme;
            applyTheme(savedTheme);
            
            // Setup Firebase authentication state listener
            auth.onAuthStateChanged(user => {
                state.authInitialized = true;
                
                if (user) {
                    // User is signed in
                    state.user = user;
                    showApp();
                    loadUserData();
                    loadUserProfile();
                    loadUserMemory();
                    // Initialize Firestore collection references
                    state.usersCollection = db.collection('users');
                    state.chatsCollection = db.collection('users').doc(user.uid).collection('chats');
                    loadChatHistory();
                    initializeMonacoEditor();
                    initializeVoiceRecognition();
                } else {
                    // User is signed out
                    state.user = null;
                    state.usersCollection = null;
                    state.chatsCollection = null;
                    showLogin();
                }
            });
            
            // Setup event listeners
            setupEventListeners();
            
            // Adjust mobile viewport height
            adjustMobileViewportHeight();
            window.addEventListener('resize', adjustMobileViewportHeight);
            
            // Detect keyboard open/close on mobile
            if (window.innerWidth <= 768px) {
                detectKeyboard();
            }
            
            // Setup scroll event listener for auto-scroll
            elements.chatMessages.addEventListener('scroll', handleScroll);
            
            // Fix mobile viewport height
            fixMobileViewportHeight();
        });

        // Initialize Monaco Editor
        function initializeMonacoEditor() {
            // Load Monaco Editor
            require.config({ paths: { vs: 'https://cdn.jsdelivr.net/npm/monaco-editor@0.34.1/min/vs' } });
            require(['vs/editor/editor.main'], function () {
                // Create editor
                const editorContainer = document.getElementById('monacoEditor');
                
                state.monacoEditor = monaco.editor.create(editorContainer, {
                    value: `// Welcome to the code editor!\n// Try writing some code here and click Run to execute it.\n\nfunction helloWorld() {\n    console.log("Hello, World!");\n    return "Hello from Nexariq AI!";\n}\n\nhelloWorld();`,
                    language: 'javascript',
                    theme: state.settings.codeTheme,
                    fontSize: parseInt(state.settings.codeFontSize),
                    automaticLayout: true,
                    minimap: {
                        enabled: true
                    },
                    lineNumbers: state.settings.lineNumbers ? 'on' : 'off',
                    scrollBeyondLastLine: true,
                    wordWrap: 'on',
                    bracketPairColorization: {
                        enabled: true
                    },
                    renderWhitespace: 'selection',
                    suggestOnTriggerCharacters: true,
                    quickSuggestions: true,
                    parameterHints: {
                        enabled: true
                    }
                });
                
                // Set up editor change listener
                state.monacoEditor.onDidChangeModelContent(() => {
                    // Auto-format if enabled
                    if (state.settings.autoFormat) {
                        setTimeout(() => {
                            state.monacoEditor.getAction('editor.action.formatDocument').run();
                        }, 500);
                    }
                });
                
                // Set up language tabs
                document.querySelectorAll('.code-editor-tab').forEach(tab => {
                    tab.addEventListener('click', () => {
                        const language = tab.getAttribute('data-language');
                        switchLanguage(language);
                        
                        // Update active tab
                        document.querySelectorAll('.code-editor-tab').forEach(t => {
                            t.classList.remove('active');
                        });
                        tab.classList.add('active');
                    });
                });
                
                // Set up run button
                elements.codeRunBtn.addEventListener('click', runCode);
                
                // Set up format button
                elements.codeFormatBtn.addEventListener('click', () => {
                    state.monacoEditor.getAction('editor.action.formatDocument').run();
                });
                
                // Set up clear output button
                elements.clearOutputBtn.addEventListener('click', () => {
                    elements.codeOutput.innerHTML = '<div class="info-box"><div class="info-box-title">Output Cleared</div><p>Output has been cleared. Run your code to see new results.</p></div>';
                });
                
                // Set up share button
                elements.codeShareBtn.addEventListener('click', shareCode);
            });
        }

        // Switch language in Monaco Editor
        function switchLanguage(language) {
            const model = state.monacoEditor.getModel();
            const value = model.getValue();
            
            monaco.editor.setModel(monaco.editor.createModel(value, getMonacoLanguage(language)));
            state.currentLanguage = language;
        }

        // Get Monaco language ID
        function getMonacoLanguage(language) {
            const languageMap = {
                'javascript': 'javascript',
                'python': 'python',
                'html': 'html',
                'css': 'css',
                'sql': 'sql',
                'json': 'json',
                'typescript': 'typescript',
                'java': 'java',
                'csharp': 'csharp',
                'cpp': 'cpp',
                'php': 'php',
                'ruby': 'ruby',
                'go': 'go',
                'rust': 'rust',
                'swift': 'swift',
                'kotlin': 'kotlin',
                'scala': 'scala',
                'r': 'r',
                'matlab': 'matlab',
                'bash': 'shell',
                'powershell': 'powershell',
                'dockerfile': 'dockerfile',
                'yaml': 'yaml',
                'xml': 'xml',
                'markdown': 'markdown'
            };
            
            return languageMap[language] || language;
        }

        // Run code in editor
        function runCode() {
            const code = state.monacoEditor.getValue();
            
            // Show loading state
            elements.codeOutput.innerHTML = '<div class="info-box"><div class="info-box-title">Running code...</div><p>Please wait while your code is being executed.</p></div>';
            
            // Simulate code execution (in a real app, this would be done on a server)
            setTimeout(() => {
                try {
                    // Create a function from the code and execute it
                    const func = new Function(code);
                    const result = func();
                    
                    // Display the result
                    let output = '<div class="info-box"><div class="info-box-title">Execution Result</div>';
                    
                    if (result !== undefined) {
                        output += `<pre>${JSON.stringify(result, null, 2)}</pre>`;
                    } else {
                        output += '<p>Code executed successfully with no return value.</p>';
                    }
                    
                    output += '</div>';
                    elements.codeOutput.innerHTML = output;
                } catch (error) {
                    // Display error
                    elements.codeOutput.innerHTML = `
                        <div class="info-box" style="background-color: rgba(239, 68, 68, 0.1); border-color: var(--error);">
                            <div class="info-box-title" style="color: var(--error);">Execution Error</div>
                            <pre>${error.toString()}</pre>
                        </div>
                    `;
                }
            }, 1000);
        }

        // Share code
        function shareCode() {
            const code = state.monacoEditor.getValue();
            
            // Create a shareable link (in a real app, this would save to a database)
            const shareId = Math.random().toString(36).substring(2, 10);
            const shareLink = `${window.location.origin}/share/${shareId}`;
            
            // Copy to clipboard
            navigator.clipboard.writeText(shareLink)
                .then(() => {
                    showToast('Share link copied to clipboard', 'success');
                })
                .catch(err => {
                    showToast('Failed to copy share link', 'error');
                    console.error('Failed to copy:', err);
                });
        }

        // Initialize voice recognition
        function initializeVoiceRecognition() {
            if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                state.voiceRecognition = new SpeechRecognition();
                state.voiceRecognition.continuous = false;
                state.voiceRecognition.interimResults = false;
                state.voiceRecognition.lang = 'en-US';
                
                state.voiceRecognition.onresult = (event) => {
                    const transcript = event.results[0][0].transcript;
                    elements.chatInput.value = transcript;
                    stopVoiceRecording();
                };
                
                state.voiceRecognition.onerror = (event) => {
                    console.error('Speech recognition error:', event.error);
                    showToast('Voice recognition error: ' + event.error, 'error');
                    stopVoiceRecording();
                };
                
                state.voiceRecognition.onend = () => {
                    stopVoiceRecording();
                });
            } else {
                console.log('Speech recognition not supported');
                state.settings.voiceInput = false;
            }
        }

        // Start voice recording
        function startVoiceRecording() {
            if (!state.voiceRecognition || !state.settings.voiceInput) {
                showToast('Voice input not available', 'warning');
                return;
            }
            
            try {
                state.voiceRecognition.start();
                state.isRecording = true;
                elements.voiceInputBtn.classList.add('recording');
                showToast('Listening...', 'success');
            } catch (error) {
                console.error('Error starting voice recognition:', error);
                showToast('Error starting voice input', 'error');
            }
        }

        // Stop voice recording
        function stopVoiceRecording() {
            if (state.voiceRecognition && state.isRecording) {
                state.voiceRecognition.stop();
                state.isRecording = false;
                elements.voiceInputBtn.classList.remove('recording');
            }
        }

        // Setup event listeners
        function setupEventListeners() {
            // Authentication
            elements.loginForm.addEventListener('submit', handleLogin);
            elements.registerForm.addEventListener('submit', handleRegister);
            elements.googleSignInBtn.addEventListener('click', signInWithGoogle);
            elements.googleSignUpBtn.addEventListener('click', signUpWithGoogle);
            elements.signOutBtn.addEventListener('click', signOut);
            elements.signOutFromProfileBtn.addEventListener('click', signOut);
            
            // Toggle between login and register
            const container = document.getElementById('loginContainer');
            const LoginLink = document.querySelector('.SignInLink');
            const RegisterLink = document.querySelector('.SignUpLink');
            
            RegisterLink.addEventListener('click', () =>{
                container.classList.add('active');
            });

            LoginLink.addEventListener('click', () => {
                container.classList.remove('active');
            });
            
            // User profile panel
            elements.userMenu.addEventListener('click', toggleUserProfilePanel);
            elements.userProfileClose.addEventListener('click', closeUserProfilePanel);
            elements.saveProfileBtn.addEventListener('click', saveUserProfile);
            elements.cancelProfileBtn.addEventListener('click', closeUserProfilePanel);
            
            // Mobile menu
            elements.mobileMenuBtn.addEventListener('click', toggleSidebar);
            elements.mobileBackBtn.addEventListener('click', goBack);
            elements.overlay.addEventListener('click', closeAllPanels);
            
            // New chat
            elements.newChatBtn.addEventListener('click', startNewChat);
            
            // Chat input
            elements.chatInput.addEventListener('keydown', handleChatInputKeydown);
            elements.chatInput.addEventListener('input', autoResizeTextarea);
            elements.chatInput.addEventListener('focus', () => {
                if (window.innerWidth <= 768) {
                    setTimeout(() => {
                        scrollToBottom();
                    }, 300);
                }
            });
            elements.sendBtn.addEventListener('click', sendMessage);
            
            // Attach file
            elements.attachBtn.addEventListener('click', attachFile);
            
            // Voice input
            elements.voiceInputBtn.addEventListener('click', () => {
                if (state.isRecording) {
                    stopVoiceRecording();
                } else {
                    startVoiceRecording();
                }
            });
            
            // Code snippet
            elements.codeSnippetBtn.addEventListener('click', insertCodeSnippet);
            
            // Settings panel
            elements.settingsBtn.addEventListener('click', toggleSettingsPanel);
            elements.settingsClose.addEventListener('click', closeSettingsPanel);
            elements.saveSettingsBtn.addEventListener('click', saveSettings);
            elements.cancelSettingsBtn.addEventListener('click', closeSettingsPanel);
            
            // Theme toggle
            elements.themeToggleBtn.addEventListener('click', toggleTheme);
            
            // Settings
            elements.codeTheme.addEventListener('change', updateCodeTheme);
            elements.codeFontSize.addEventListener('change', updateCodeFontSize);
            elements.autoFormatToggle.addEventListener('click', toggleAutoFormat);
            elements.lineNumbersToggle.addEventListener('click', toggleLineNumbers);
            elements.codeExecutionToggle.addEventListener('click', toggleCodeExecution);
            elements.autoRunToggle.addEventListener('click', toggleAutoRun);
            elements.voiceInputToggle.addEventListener('click', toggleVoiceInput);
            
            // Chat history management
            elements.searchChatBtn.addEventListener('click', showSearchModal);
            elements.exportChatBtn.addEventListener('click', exportChatHistory);
            elements.clearChatBtn.addEventListener('click', showClearChatsConfirm);
            
            // Chat filter buttons
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const filter = btn.getAttribute('data-filter');
                    filterChats(filter);
                    
                    // Update active filter button
                    document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                });
            });
            
            // Confirmation modal
            elements.confirmCancelBtn.addEventListener('click', hideConfirmModal);
            elements.confirmOkBtn.addEventListener('click', confirmAction);
            
            // Search modal
            elements.searchCloseBtn.addEventListener('click', hideSearchModal);
            elements.searchInput.addEventListener('input', handleSearch);
            
            // Rename modal
            elements.renameCancelBtn.addEventListener('click', hideRenameModal);
            elements.renameSaveBtn.addEventListener('click', saveRenameChat);
            
            // Window resize
            window.addEventListener('resize', handleWindowResize);
            
            // FAB button
            elements.fabBtn.addEventListener('click', () => {
                // Focus on the code editor
                state.monacoEditor.focus();
            });
        }

        // Authentication functions
        async function handleLogin(e) {
            e.preventDefault();
            
            const email = elements.loginEmail.value.trim();
            const password = elements.loginPassword.value;
            
            // Hide any previous messages
            elements.loginError.classList.remove('show');
            elements.loginSuccess.classList.remove('show');
            
            // Show loading state
            elements.loginBtn.innerHTML = '<span class="spinner"></span> Logging in...';
            elements.loginBtn.disabled = true;
            
            try {
                // Sign in with email and password
                const result = await auth.signInWithEmailAndPassword(email, password);
                
                // Show success message
                elements.loginSuccess.textContent = 'Login successful! Redirecting...';
                elements.loginSuccess.classList.add('show');
                
                // Reset form
                elements.loginForm.reset();
                
                // Show success toast
                showToast('Signed in successfully', 'success');
            } catch (error) {
                console.error('Error signing in:', error);
                
                // Show appropriate error message
                let errorMessage = 'Error signing in';
                
                if (error.code === 'auth/user-not-found') {
                    errorMessage = 'User not found. Please register first.';
                } else if (error.code === 'auth/wrong-password') {
                    errorMessage = 'Incorrect password. Please try again.';
                } else if (error.code === 'auth/invalid-email') {
                    errorMessage = 'Invalid email address. Please check and try again.';
                } else if (error.code === 'auth/user-disabled') {
                    errorMessage = 'This account has been disabled. Please contact support.';
                } else if (error.code === 'auth/too-many-requests') {
                    errorMessage = 'Too many unsuccessful login attempts. Please try again later.';
                } else if (error.message) {
                    errorMessage = error.message;
                }
                
                elements.loginError.textContent = errorMessage;
                elements.loginError.classList.add('show');
            } finally {
                // Reset button state
                elements.loginBtn.innerHTML = 'Login';
                elements.loginBtn.disabled = false;
            }
        }

        async function handleRegister(e) {
            e.preventDefault();
            
            const name = elements.registerName.value.trim();
            const email = elements.registerEmail.value.trim();
            const password = elements.registerPassword.value;
            
            // Hide any previous messages
            elements.registerError.classList.remove('show');
            elements.registerSuccess.classList.remove('show');
            
            // Validate password
            if (password.length < 6) {
                elements.registerError.textContent = 'Password must be at least 6 characters long';
                elements.registerError.classList.add('show');
                return;
            }
            
            // Show loading state
            elements.registerBtn.innerHTML = '<span class="spinner"></span> Registering...';
            elements.registerBtn.disabled = true;
            
            try {
                // Create user with email and password
                const result = await auth.createUserWithEmailAndPassword(email, password);
                
                // Update display name
                await result.user.updateProfile({
                    displayName: name
                });
                
                // Show success message
                elements.registerSuccess.textContent = 'Registration successful! Redirecting...';
                elements.registerSuccess.classList.add('show');
                
                // Reset form
                elements.registerForm.reset();
                
                // Show success toast
                showToast('Account created successfully', 'success');
            } catch (error) {
                console.error('Error registering:', error);
                
                // Show appropriate error message
                let errorMessage = 'Error creating account';
                
                if (error.code === 'auth/email-already-in-use') {
                    errorMessage = 'Email already in use. Please sign in or use a different email.';
                } else if (error.code === 'auth/invalid-email') {
                    errorMessage = 'Invalid email address. Please check and try again.';
                } else if (error.code === 'auth/weak-password') {
                    errorMessage = 'Password is too weak. Please choose a stronger password.';
                } else if (error.message) {
                    errorMessage = error.message;
                }
                
                elements.registerError.textContent = errorMessage;
                elements.registerError.classList.add('show');
            } finally {
                // Reset button state
                elements.registerBtn.innerHTML = 'Register';
                elements.registerBtn.disabled = false;
            }
        }

        async function signInWithGoogle() {
            // Show loading state
            elements.googleSignInBtn.innerHTML = '<span class="spinner"></span> Signing in...';
            elements.googleSignInBtn.disabled = true;
            elements.loginError.classList.remove('show');
            
            try {
                const provider = new firebase.auth.GoogleAuthProvider();
                const result = await auth.signInWithPopup(provider);
                
                showToast('Signed in with Google', 'success');
            } catch (error) {
                console.error('Error signing in with Google:', error);
                
                // Show appropriate error message
                let errorMessage = 'Error signing in with Google';
                
                if (error.code === 'auth/user-not-found') {
                    errorMessage = 'Account not found. Please sign up first.';
                } else if (error.code === 'auth/wrong-password') {
                    errorMessage = 'Incorrect password. Please try again.';
                } else if (error.code === 'auth/invalid-email') {
                    errorMessage = 'Invalid email address. Please check and try again.';
                } else if (error.code === 'auth/user-disabled') {
                    errorMessage = 'This account has been disabled. Please contact support.';
                } else if (error.code === 'auth/too-many-requests') {
                    errorMessage = 'Too many unsuccessful login attempts. Please try again later.';
                } else if (error.message) {
                    errorMessage = error.message;
                }
                
                elements.loginError.textContent = errorMessage;
                elements.loginError.classList.add('show');
            } finally {
                // Reset button state
                elements.googleSignInBtn.innerHTML = '<i class="bx bxl-google"></i> Login with Google';
                elements.googleSignInBtn.disabled = false;
            }
        }

        async function signUpWithGoogle() {
            // Show loading state
            elements.googleSignUpBtn.innerHTML = '<span class="spinner"></span> Signing up...';
            elements.googleSignUpBtn.disabled = true;
            elements.registerError.classList.remove('show');
            
            try {
                const provider = new firebase.auth.GoogleAuthProvider();
                const result = await auth.signInWithPopup(provider);
                
                showToast('Signed up with Google', 'success');
            } catch (error) {
                console.error('Error signing up with Google:', error);
                
                // Show appropriate error message
                let errorMessage = 'Error signing up with Google';
                
                if (error.code === 'auth/user-not-found') {
                    errorMessage = 'Account not found. Please sign up first.';
                } else if (error.code === 'auth/wrong-password') {
                    errorMessage = 'Incorrect password. Please try again.';
                } else if (error.code === 'auth/invalid-email') {
                    errorMessage = 'Invalid email address. Please check and try again.';
                } else if (error.code === 'auth/user-disabled') {
                    errorMessage = 'This account has been disabled. Please contact support.';
                } else if (error.code === 'auth/too-many-requests') {
                    errorMessage = 'Too many unsuccessful login attempts. Please try again later.';
                } else if (error.message) {
                    errorMessage = error.message;
                }
                
                elements.registerError.textContent = errorMessage;
                elements.registerError.classList.add('show');
            } finally {
                // Reset button state
                elements.googleSignUpBtn.innerHTML = '<i class="bx bxl-google"></i> Sign up with Google';
                elements.googleSignUpBtn.disabled = false;
            }
        }

        function signOut() {
            auth.signOut()
                .then(() => {
                    showToast('Signed out successfully', 'success');
                    
                    // Clear local state
                    state.messages = [];
                    state.chatHistory = [];
                    state.currentChatId = null;
                    state.userMemory = {};
                    state.userPreferences = {};
                    state.likedMessages.clear();
                    state.dislikedMessages.clear();
                    
                    // Clear localStorage
                    localStorage.removeItem('nexariqState');
                })
                .catch(error => {
                    console.error('Error signing out:', error);
                    showToast('Error signing out', 'error');
                });
        }

        // User profile panel functions
        function toggleUserProfilePanel() {
            elements.userProfilePanel.classList.toggle('active');
            elements.overlay.classList.toggle('active');
            
            // Load user profile data when opening
            if (elements.userProfilePanel.classList.contains('active')) {
                loadUserProfile();
            }
        }

        function closeUserProfilePanel() {
            elements.userProfilePanel.classList.remove('active');
            elements.overlay.classList.remove('active');
        }

        // Save user profile
        function saveUserProfile() {
            const displayName = elements.profileDisplayName.value.trim();
            
            if (displayName) {
                // Update in Firebase
                const userRef = db.collection('users').doc(state.user.uid);
                userRef.update({
                    'memory.name': displayName
                }).then(() => {
                    // Update state
                    state.userMemory.name = displayName;
                    
                    // Update UI
                    elements.userAvatar.textContent = displayName.charAt(0).toUpperCase();
                    elements.userName.textContent = displayName;
                    elements.userProfileName.textContent = displayName;
                    elements.userProfileAvatar.textContent = displayName.charAt(0).toUpperCase();
                    
                    showToast('Profile updated successfully', 'success');
                }).catch(error => {
                    console.error('Error updating profile:', error);
                    showToast('Error updating profile', 'error');
                });
            }
            
            closeUserProfilePanel();
        }

        // Theme functions
        function applyTheme(theme) {
            document.documentElement.setAttribute('data-theme', theme);
            
            // Update theme toggle button
            if (theme === 'dark') {
                elements.themeToggleBtn.innerHTML = '<i class="fas fa-moon"></i>';
            } else {
                elements.themeToggleBtn.innerHTML = '<i class="fas fa-sun"></i>';
            }
        }

        // Toggle theme
        function toggleTheme() {
            const currentTheme = document.documentElement.getAttribute('data-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            
            document.documentElement.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
            
            // Update theme toggle button
            if (newTheme === 'dark') {
                elements.themeToggleBtn.innerHTML = '<i class="fas fa-moon"></i>';
            } else {
                elements.themeToggleBtn.innerHTML = '<i class="fas fa-sun"></i>';
            }
            
            // Update Monaco Editor theme
            if (state.monacoEditor) {
                monaco.editor.setTheme(newTheme === 'dark' ? 'vs-dark' : 'vs');
            }
            
            showToast(`Theme changed to ${newTheme}`, 'success');
        }

        // Update code theme
        function updateCodeTheme() {
            const theme = elements.codeTheme.value;
            state.settings.codeTheme = theme;
            
            if (state.monacoEditor) {
                monaco.editor.setTheme(theme);
            }
            
            saveSettings();
        }

        // Update code font size
        function updateCodeFontSize() {
            const fontSize = elements.codeFontSize.value;
            state.settings.codeFontSize = fontSize;
            
            if (state.monacoEditor) {
                state.monacoEditor.updateOptions({
                    fontSize: parseInt(fontSize)
                });
            }
            
            saveSettings();
        }

        // Toggle auto format
        function toggleAutoFormat() {
            state.settings.autoFormat = !state.settings.autoFormat;
            elements.autoFormatToggle.classList.toggle('active');
            saveSettings();
        }

        // Toggle line numbers
        function toggleLineNumbers() {
            state.settings.lineNumbers = !state.settings.lineNumbers;
            elements.lineNumbersToggle.classList.toggle('active');
            
            if (state.monacoEditor) {
                state.monacoEditor.updateOptions({
                    lineNumbers: state.settings.lineNumbers ? 'on' : 'off'
                });
            }
            
            saveSettings();
        }

        // Toggle code execution
        function toggleCodeExecution() {
            state.settings.codeExecution = !state.settings.codeExecution;
            elements.codeExecutionToggle.classList.toggle('active');
            saveSettings();
        }

        // Toggle auto run
        function toggleAutoRun() {
            state.settings.autoRun = !state.settings.autoRun;
            elements.autoRunToggle.classList.toggle('active');
            saveSettings();
        }

        // Toggle voice input
        function toggleVoiceInput() {
            state.settings.voiceInput = !state.settings.voiceInput;
            elements.voiceInputToggle.classList.toggle('active');
            
            if (state.settings.voiceInput) {
                initializeVoiceRecognition();
            }
            
            saveSettings();
        }

        // Save settings
        function saveSettings() {
            saveUserData();
            showToast('Settings saved successfully', 'success');
        }

        // Show login screen
        function showLogin() {
            elements.loginScreen.classList.remove('hidden');
            elements.appContainer.classList.add('hidden');
        }

        // Show app
        function showApp() {
            elements.loginScreen.classList.add('hidden');
            elements.appContainer.classList.remove('hidden');
            
            // Update user info
            if (state.user) {
                elements.userAvatar.textContent = state.user.displayName ? state.user.displayName.charAt(0).toUpperCase() : 'U';
                elements.userName.textContent = state.user.displayName || 'User';
                elements.userEmail.textContent = state.user.email || '';
            }
        }

        // Load user data from Firestore
        function loadUserData() {
            if (!state.user) return;
            
            const userRef = db.collection('users').doc(state.user.uid);
            
            userRef.get().then(doc => {
                if (doc.exists) {
                    const userData = doc.data();
                    
                    // Load settings
                    if (userData.settings) {
                        state.settings = { ...state.settings, ...userData.settings };
                        applySettings();
                    }
                    
                    // Load user memory and preferences
                    if (userData.memory) {
                        state.userMemory = userData.memory;
                    }
                    
                    if (userData.preferences) {
                        state.userPreferences = userData.preferences;
                    }
                    
                    // Load liked and disliked messages
                    if (userData.likedMessages) {
                        state.likedMessages = new Set(userData.likedMessages);
                    }
                    
                    if (userData.dislikedMessages) {
                        state.dislikedMessages = new Set(userData.dislikedMessages);
                    }
                }
            }).catch(error => {
                console.error('Error loading user data:', error);
                showToast('Error loading user data', 'error');
            });
        }

        // Load user profile
        function loadUserProfile() {
            if (!state.user) return;
            
            // Update profile panel with user info
            elements.userProfileAvatar.textContent = state.user.displayName ? state.user.displayName.charAt(0).toUpperCase() : 'U';
            elements.userProfileName.textContent = state.user.displayName || 'User';
            elements.userProfileEmail.textContent = state.user.email || '';
            
            // Set display name input
            elements.profileDisplayName.value = state.userMemory.name || state.user.displayName || '';
            
            // Format user ID
            const formattedUserId = state.user.uid
                .replace(/[^a-zA-Z0-9]/g, '') // Remove special characters
                .substring(0, 8); // Limit to 8 characters
            elements.userProfileId.textContent = formattedUserId;
            
            // Get provider info
            if (state.user.providerData && state.user.providerData.length > 0) {
                const provider = state.user.providerData[0].providerId;
                elements.userProfileProvider.textContent = provider === 'google.com' ? 'Google' : 
                                                        provider === 'apple.com' ? 'Apple' : provider;
            }
            
            // Format dates
            if (state.user.metadata) {
                const creationTime = new Date(state.user.metadata.creationTime);
                const lastSignInTime = new Date(state.user.metadata.lastSignInTime);
                
                elements.userProfileCreated.textContent = creationTime.toLocaleString();
                elements.userProfileLastSignIn.textContent = lastSignInTime.toLocaleString();
            }
        }

        // Save user data to Firestore
        function saveUserData() {
            if (!state.user) return;
            
            const userRef = db.collection('users').doc(state.user.uid);
            
            userRef.update({
                settings: state.settings,
                memory: state.userMemory,
                preferences: state.userPreferences,
                likedMessages: Array.from(state.likedMessages),
                dislikedMessages: Array.from(state.dislikedMessages),
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            }).catch(error => {
                console.error('Error saving user data:', error);
                showToast('Error saving user data', 'error');
            });
        }

        // Close all panels
        function closeAllPanels() {
            elements.settingsPanel.classList.remove('active');
            elements.userProfilePanel.classList.remove('active');
            elements.overlay.classList.remove('active');
        }

        // Toggle sidebar
        function toggleSidebar() {
            elements.sidebar.classList.toggle('active');
            elements.overlay.classList.toggle('active');
        }

        // Close sidebar
        function closeSidebar() {
            elements.sidebar.classList.remove('active');
            elements.overlay.classList.remove('active');
        }

        // Update mobile back button
        function updateMobileBackButton() {
            if (window.innerWidth <= 768 && state.currentView !== 'chat') {
                elements.mobileBackBtn.classList.add('visible');
            } else {
                elements.mobileBackBtn.classList.remove('visible');
            }
        }

        // Go back to previous view
        function goBack() {
            // Default to chat view
            state.currentView = 'chat';
            updateMobileBackButton();
            closeAllPanels();
        }

        // Start new chat
        function startNewChat() {
            // Reset current chat
            state.messages = [];
            state.currentChatId = null;
            state.currentChatDoc = null;
            
            // Reset current chat title
            state.currentChatTitle = 'Current Session';
            
            // Add welcome message
            const userName = state.userMemory.name || '';
            const welcomeMessage = userName 
                ? `## Hello, <span class="user-name-colorful">${userName}</span>! I'm <span class="brand-lynxa">Lynxa Pro</span>

I'm an advanced AI code assistant developed by <span class="brand-nexariq">Nexariq (AJ STUDIOZ)</span>. I specialize in helping with coding tasks and can execute code in multiple languages.

<div class="info-box">
    <div class="info-box-title">My Coding Capabilities</div>
    <ul>
        <li>Writing and debugging code in multiple languages</li>
        <li>Explaining algorithms and data structures</li>
        <li>Optimizing code for performance</li>
        <li>Converting between programming languages</li>
        <li>Creating APIs and web applications</li>
        <li>Database design and queries</li>
        <li>Code review and best practices</li>
    </ul>
</div>

I have access to a powerful code execution environment and can help you with everything from simple scripts to complex applications.

Try pasting your code in the editor below and clicking Run to see it in action!`
                : `## Hello! I'm <span class="brand-lynxa">Lynxa Pro</span>

I'm an advanced AI code assistant developed by <span class="brand-nexariq">Nexariq (AJ STUDIOZ)</span>. I specialize in helping with coding tasks and can execute code in multiple languages.

<div class="info-box">
    <div class="info-box-title">My Coding Capabilities</div>
    <ul>
        <li>Writing and debugging code in multiple languages</li>
        <li>Explaining algorithms and data structures</li>
        <li>Optimizing code for performance</li>
        <li>Converting between programming languages</li>
        <li>Creating APIs and web applications</li>
        <li>Database design and queries</li>
        <li>Code review and best practices</li>
    </ul>
</div>

I have access to a powerful code execution environment and can help you with everything from simple scripts to complex applications.

Try pasting your code in the editor below and clicking Run to see it in action!`;
            
            state.messages.push({
                id: generateId(),
                role: 'assistant',
                content: welcomeMessage,
                timestamp: new Date().toISOString()
            });
            
            renderMessages();
            saveState();
            
            // Update active chat in sidebar
            document.querySelectorAll('.chat-item').forEach(item => {
                item.classList.remove('active');
            });
            
            const activeChat = document.createElement('div');
            activeChat.className = 'chat-item active';
            activeChat.setAttribute('data-chat-id', 'current');
            activeChat.innerHTML = `
                <div class="chat-item-icon">
                    <i class="fas fa-code"></i>
                </div>
                <div class="chat-item-content">
                    <div class="chat-item-title">${state.currentChatTitle}</div>
                    <div class="chat-item-date">Just now</div>
                </div>
            `;
            
            elements.chatHistory.insertBefore(activeChat, elements.chatHistory.firstChild);
            
            showToast('New session started', 'success');
        }

        // Render messages
        function renderMessages() {
            elements.chatMessages.innerHTML = '';
            
            state.messages.forEach(message => {
                const messageEl = document.createElement('div');
                messageEl.className = `message ${message.role === 'assistant' ? 'ai' : message.role}`;
                
                const avatar = message.role === 'user' 
                    ? (state.userMemory.name ? state.userMemory.name.charAt(0).toUpperCase() : 'U')
                    : `<img src="${aiAvatarUrl}" alt="Lynxa Pro" class="message-avatar-img">`;
                
                // Use full timestamp format for messages
                const time = new Date(message.timestamp).toLocaleString();
                
                messageEl.innerHTML = `
                    <div class="message-avatar">${avatar}</div>
                    <div class="message-content">
                        <div class="message-text">${formatMessageContent(message.content)}</div>
                        ${message.role === 'assistant' ? `
                            <div class="message-actions">
                                <button class="message-action-btn" title="Copy" onclick="copyMessage('${message.id}')">
                                    <i class="fas fa-copy"></i>
                                    <span class="tooltip">Copy</span>
                                </button>
                                <button class="message-action-btn" title="Good response" onclick="likeMessage('${message.id}')">
                                    <i class="fas fa-thumbs-up"></i>
                                    <span class="tooltip">Good response</span>
                                </button>
                                <button class="message-action-btn" title="Bad response" onclick="dislikeMessage('${message.id}')">
                                    <i class="fas fa-thumbs-down"></i>
                                    <span class="tooltip">Bad response</span>
                                </button>
                            </div>
                        ` : ''}
                        <div class="message-time">${time}</div>
                    </div>
                `;
                
                elements.chatMessages.appendChild(messageEl);
            });
            
            // Scroll to bottom if auto-scroll is enabled
            if (state.autoScroll) {
                scrollToBottom();
            }
            
            // Highlight code blocks
            setTimeout(() => {
                elements.chatMessages.querySelectorAll('pre code').forEach(block => {
                    hljs.highlightElement(block);
                });
            }, 0);
        }

        // Format message content (markdown to HTML)
        function formatMessageContent(content) {
            // Replace user's name with styled span if it exists
            if (state.userMemory.name) {
                const nameRegex = new RegExp(`\\b${state.userMemory.name}\\b`, 'gi');
                content = content.replace(nameRegex, `<span class="user-name-colorful">${state.userMemory.name}</span>`);
            }
            
            // Use marked to parse markdown
            const html = marked.parse(content);
            
            // Process code blocks
            const processedHtml = html.replace(/<pre><code class="language-([^"]+)">([\s\S]*?)<\/code><\/pre>/g, (match, language, code) => {
                const codeId = 'code-' + Math.random().toString(36).substr(2, 9);
                const escapedCode = code.replace(/</g, '&lt;').replace(/>/g, '&gt;');
                
                return `
                    <div class="enhanced-code-block">
                        <div class="enhanced-code-header">
                            <div class="enhanced-code-language">${language}</div>
                            <div class="enhanced-code-actions">
                                <button class="copy-btn" onclick="copyCode('${codeId}')">
                                    <i class="fas fa-copy"></i>
                                    <span>Copy</span>
                                </button>
                                <button class="run-btn" onclick="runCodeInEditor('${codeId}', '${language}')">
                                    <i class="fas fa-play"></i>
                                    <span>Run</span>
                                </button>
                            </div>
                        </div>
                        <div class="enhanced-code-content">
                            <pre><code id="${codeId}" class="language-${language}">${escapedCode}</code></pre>
                        </div>
                    </div>
                `;
            });
            
            // Sanitize HTML
            return DOMPurify.sanitize(processedHtml);
        }

        // Handle chat input keydown
        function handleChatInputKeydown(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        }

        // Auto resize textarea
        function autoResizeTextarea() {
            elements.chatInput.style.height = 'auto';
            elements.chatInput.style.height = Math.min(elements.chatInput.scrollHeight, 200) + 'px';
        }

        // Send message
        async function sendMessage() {
            const message = elements.chatInput.value.trim();
            if (!message || state.isTyping) return;
            
            // Create a new AbortController for this request
            state.abortController = new AbortController();
            
            // Add user message
            const userMessage = {
                id: generateId(),
                role: 'user',
                content: message,
                timestamp: new Date().toISOString()
            };
            
            state.messages.push(userMessage);
            renderMessages();
            saveState();
            
            // Clear input
            elements.chatInput.value = '';
            elements.chatInput.style.height = 'auto';
            
            // Show typing indicator
            showTypingIndicator();
            
            try {
                // Prepare messages for API
                const systemMessage = {
                    role: 'system',
                    content: `You are Lynxa Pro, an advanced AI code assistant developed by Nexariq (AJ STUDIOZ). 

 ${state.userMemory.name ? `The user's name is ${state.userMemory.name}. Always address them by their name.` : ''}

I specialize in helping with coding tasks and can execute code in multiple languages. When providing code examples, always use proper syntax highlighting and explain the code clearly.

Remember the user's preferences and previous interactions to provide personalized responses.`
                };
                
                // Convert messages to API format
                const apiMessages = [systemMessage];
                
                // Add conversation history
                state.messages.forEach(msg => {
                    apiMessages.push({
                        role: msg.role === 'assistant' ? 'assistant' : 'user',
                        content: msg.content
                    });
                });
                
                // Create AI message element for streaming
                const messageId = generateId();
                const timestamp = new Date().toISOString();
                
                // Create message element
                const messageEl = document.createElement('div');
                messageEl.className = 'message ai';
                messageEl.id = `message-${messageId}`;
                
                // Use full timestamp format for messages
                const time = new Date(message.timestamp).toLocaleString();
                
                messageEl.innerHTML = `
                    <div class="message-avatar">
                        <img src="${aiAvatarUrl}" alt="Lynxa Pro" class="message-avatar-img">
                    </div>
                    <div class="message-content">
                        <div class="message-text typing-text" id="text-${messageId}"></div>
                        <div class="message-actions">
                            <button class="message-action-btn" title="Copy" onclick="copyMessage('${messageId}')">
                                <i class="fas fa-copy"></i>
                                <span class="tooltip">Copy</span>
                            </button>
                            <button class="message-action-btn" title="Good response" onclick="likeMessage('${messageId}')">
                                <i class="fas fa-thumbs-up"></i>
                                <span class="tooltip">Good response</span>
                            </button>
                            <button class="message-action-btn" title="Bad response" onclick="dislikeMessage('${messageId}')">
                                <i class="fas fa-thumbs-down"></i>
                                <span class="tooltip">Bad response</span>
                            </button>
                        </div>
                        <div class="message-time">${time}</div>
                    </div>
                `;
                
                elements.chatMessages.appendChild(messageEl);
                
                // Add to state
                const aiMessage = {
                    id: messageId,
                    role: 'assistant',
                    content: '',
                    timestamp
                };
                
                state.messages.push(aiMessage);
                
                // Remove typing indicator
                hideTypingIndicator();
                
                // Start streaming response
                state.streamingResponse = true;
                
                try {
                    // Send request to our backend API with streaming
                    const response = await fetch('/api/chat', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            messages: apiMessages,
                            model: 'llama-3.3-70b-versatile',
                            stream: true,
                            userId: state.user ? state.user.uid : null
                        }),
                        signal: state.abortController.signal
                    });
                    
                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.error || 'API request failed');
                    }
                    
                    // Handle streaming response
                    const reader = response.body.getReader();
                    const decoder = new TextDecoder();
                    let aiResponse = '';
                    let buffer = '';
                    
                    while (true) {
                        const { done, value } = await reader.read();
                        
                        if (done) break;
                        
                        // Decode the received chunk
                        const chunk = decoder.decode(value, { stream: true });
                        buffer += chunk;
                        
                        // Split by lines to handle multiple SSE events
                        const lines = buffer.split('\n');
                        buffer = lines.pop(); // Keep the incomplete line in buffer
                        
                        for (const line of lines) {
                            if (line.startsWith('data: ') && line !== 'data: [DONE]') {
                                try {
                                    const data = JSON.parse(line.substring(6));
                                    
                                    // Extract content from the streaming response
                                    if (data.choices && data.choices[0] && data.choices[0].delta && data.choices[0].delta.content) {
                                        const content = data.choices[0].delta.content;
                                        aiResponse += content;
                                        
                                        // Update the message content in the DOM
                                        const textElement = document.getElementById(`text-${messageId}`);
                                        if (textElement) {
                                            textElement.innerHTML = formatMessageContent(aiResponse);
                                            
                                            // Auto-scroll if enabled
                                            if (state.autoScroll) {
                                                scrollToBottom();
                                            }
                                        }
                                    }
                                } catch (e) {
                                    console.error('Error parsing streaming response:', e);
                                }
                            }
                        }
                    }
                    
                    // Update the message in state
                    aiMessage.content = aiResponse;
                    
                    // Highlight code blocks after streaming is complete
                    messageEl.querySelectorAll('pre code').forEach(block => {
                        hljs.highlightElement(block);
                    });
                    
                    // Save state after streaming is complete
                    saveState();
                    saveUserData();
                    
                } catch (error) {
                    // If the error is due to abort, don't show an error message
                    if (error.name === 'AbortError') {
                        console.log('Request was aborted');
                        return;
                    }
                    
                    console.error('Error:', error);
                    
                    // Add error message
                    aiMessage.content = `I'm sorry, I encountered an error: ${error.message}`;
                    
                    // Update the message content in the DOM
                    const textElement = document.getElementById(`text-${messageId}`);
                    if (textElement) {
                        textElement.innerHTML = formatMessageContent(aiMessage.content);
                    }
                    
                    showToast('Error processing your request', 'error');
                } finally {
                    // Reset streaming state
                    state.streamingResponse = false;
                    state.abortController = null;
                    
                    // Save state after streaming is complete
                    saveState();
                    saveUserData();
                }
                
            } catch (error) {
                console.error('Error:', error);
                hideTypingIndicator();
                
                // Add error message with typing effect
                addAIMessageWithTyping(`I'm sorry, I encountered an error: ${error.message}`);
                
                showToast('Error processing your request', 'error');
            } finally {
                // Re-enable send button
                state.isTyping = false;
                elements.sendBtn.disabled = false;
                elements.chatInput.focus();
            }
        }

        // Add AI message with typing effect
        function addAIMessageWithTyping(content) {
            const messageId = generateId();
            const timestamp = new Date().toISOString();
            
            // Create message element
            const messageEl = document.createElement('div');
            messageEl.className = 'message ai';
            messageEl.id = `message-${messageId}`;
            
            // Use full timestamp format for messages
            const time = new Date(message.timestamp).toLocaleString();
            
            messageEl.innerHTML = `
                <div class="message-avatar">
                    <img src="${aiAvatarUrl}" alt="Lynxa Pro" class="message-avatar-img">
                </div>
                <div class="message-content">
                    <div class="message-text typing-text" id="text-${messageId}"></div>
                    <div class="message-actions">
                        <button class="message-action-btn" title="Copy" onclick="copyMessage('${messageId}')">
                            <i class="fas fa-copy"></i>
                            <span class="tooltip">Copy</span>
                        </button>
                        <button class="message-action-btn" title="Good response" onclick="likeMessage('${messageId}')">
                            <i class="fas fa-thumbs-up"></i>
                            <span class="tooltip">Good response</span>
                        </button>
                        <button class="message-action-btn" title="Bad response" onclick="dislikeMessage('${messageId}')">
                            <i class="fas fa-thumbs-down"></i>
                            <span class="tooltip">Bad response</span>
                        </button>
                    </div>
                    <div class="message-time">${time}</div>
                </div>
            `;
            
            elements.chatMessages.appendChild(messageEl);
            
            // Add to state
            state.messages.push({
                id: messageId,
                role: 'assistant',
                content,
                timestamp
            });
            
            // Get typing speed
            const typingSpeed = typingSpeeds[state.settings.typingSpeed] || typingSpeeds.medium;
            
            // Start typing effect
            typeText(content, `text-${messageId}`, typingSpeed, () => {
                // Highlight code blocks after typing is complete
                messageEl.querySelectorAll('pre code').forEach(block => {
                    hljs.highlightElement(block);
                });
                
                // Save state after typing is complete
                saveState();
                saveUserData();
            });
            
            // Scroll to bottom
            scrollToBottom();
        }

        // Type text with typing effect
        function typeText(text, elementId, speed, callback) {
            const element = document.getElementById(elementId);
            if (!element) return;
            
            let i = 0;
            const isCodeBlock = text.includes('```');
            
            // If instant, just set the content and return
            if (speed === 0) {
                element.innerHTML = formatMessageContent(text);
                if (callback) callback();
                return;
            }
            
            function type() {
                if (i < text.length) {
                    // Check if we're at a code block
                    if (text.substring(i, i + 3) === '```') {
                        // Find the end of the code block
                        const endOfCodeBlock = text.indexOf('```', i + 3);
                        if (endOfCodeBlock !== -1) {
                            // Add the entire code block at once
                            const codeBlock = text.substring(i, endOfCodeBlock + 3);
                            element.innerHTML = formatMessageContent(text.substring(0, endOfCodeBlock + 3));
                            i = endOfCodeBlock + 3;
                            
                            // Continue typing after a short delay
                            setTimeout(type, speed * 10);
                            return;
                        }
                    }
                    
                    // Add one character at a time
                    element.innerHTML = formatMessageContent(text.substring(0, i + 1));
                    i++;
                    
                    // Continue typing
                    setTimeout(type, speed);
                } else if (callback) {
                    callback();
                }
            }
            
            type();
        }

        // Scroll to bottom function
        function scrollToBottom() {
            requestAnimationFrame(() => {
                elements.chatMessages.scrollTop = elements.chatMessages.scrollHeight;
            });
        }

        // Show typing indicator
        function showTypingIndicator() {
            state.isTyping = true;
            elements.sendBtn.disabled = true;
            
            const typingIndicator = document.createElement('div');
            typingIndicator.className = 'message ai';
            typingIndicator.id = 'typingIndicator';
            
            typingIndicator.innerHTML = `
                <div class="message-avatar">
                    <img src="${aiAvatarUrl}" alt="Lynxa Pro" class="message-avatar-img">
                </div>
                <div class="message-content">
                    <div class="typing-indicator">
                        <div class="typing-dot"></div>
                        <div class="typing-dot"></div>
                        <div class="typing-dot"></div>
                    </div>
                </div>
            `;
            
            elements.chatMessages.appendChild(typingIndicator);
            
            // Use requestAnimationFrame to ensure the element is rendered before scrolling
            requestAnimationFrame(() => {
                scrollToBottom();
            });
        }

        // Hide typing indicator
        function hideTypingIndicator() {
            state.isTyping = false;
            elements.sendBtn.disabled = false;
            
            const typingIndicator = document.getElementById('typingIndicator');
            if (typingIndicator) {
                typingIndicator.remove();
            }
        }

        // Attach file
        function attachFile() {
            const input = document.createElement('input');
            input.type = 'file';
            input.multiple = true;
            input.onchange = handleFileSelect;
            input.click();
        }

        // Handle file select
        function handleFileSelect(event) {
            const files = event.target.files;
            
            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                const fileId = generateId();
                
                // Add file to chat
                const fileMessage = {
                    id: generateId(),
                    role: 'user',
                    content: `Attached file: ${file.name} (${formatFileSize(file.size)})`,
                    timestamp: new Date().toISOString(),
                    attachments: [{
                        id: fileId,
                        name: file.name,
                        size: file.size,
                        type: file.type
                    }]
                };
                
                state.messages.push(fileMessage);
            }
            
            renderMessages();
            saveState();
            
            showToast(`${files.length} file(s) attached`, 'success');
        }

        // Format file size
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        // Generate ID
        function generateId() {
            return Date.now().toString(36) + Math.random().toString(36).substr(2);
        }

        // Show confirmation modal
        function showConfirmModal(title, description, callback) {
            elements.confirmTitle.textContent = title;
            elements.confirmDescription.textContent = description;
            elements.confirmModal.classList.add('active');
            state.confirmCallback = callback;
        }

        // Hide confirmation modal
        function hideConfirmModal() {
            elements.confirmModal.classList.remove('active');
            state.confirmCallback = null;
        }

        // Confirm action
        function confirmAction() {
            if (state.confirmCallback) {
                state.confirmCallback();
            }
            hideConfirmModal();
        }

        // Show search modal
        function showSearchModal() {
            elements.searchModal.classList.add('active');
            elements.searchInput.value = '';
            elements.searchInput.focus();
            handleSearch();
        }

        // Hide search modal
        function hideSearchModal() {
            elements.searchModal.classList.remove('active');
        }

        // Handle search
        function handleSearch() {
            const query = elements.searchInput.value.toLowerCase().trim();
            
            // Clear previous results
            elements.searchResults.innerHTML = '';
            
            if (!query) {
                elements.searchResults.innerHTML = `
                    <div class="search-result-item">
                        <div class="search-result-title">No results found</div>
                        <div class="search-result-preview">Try a different search term</div>
                    </div>
                `;
                return;
            }
            
            // Search in current chat
            const results = [];
            
            state.messages.forEach((message, index) => {
                if (message.role === 'user' || message.role === 'assistant') {
                    const content = message.content.toLowerCase();
                    const matchIndex = content.indexOf(query);
                    
                    if (matchIndex !== -1) {
                        results.push({
                            message,
                            matchIndex
                        });
                    }
                }
            });
            
            if (results.length === 0) {
                elements.searchResults.innerHTML = `
                    <div class="search-result-item">
                        <div class="search-result-title">No results found</div>
                        <div class="search-result-preview">Try a different search term</div>
                    </div>
                `;
                return;
            }
            
            // Add search results
            results.forEach(result => {
                addSearchResult(result.message, result.matchIndex);
            });
        }

        // Add search result to UI
        function addSearchResult(message, matchIndex) {
            const resultItem = document.createElement('div');
            resultItem.className = 'search-result-item';
            resultItem.onclick = () => {
                // Scroll to the message
                const messageEl = document.getElementById(`message-${message.id}`);
                if (messageEl) {
                    messageEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
                
                // Close search modal
                hideSearchModal();
            };
            
            // Get preview text (highlight match)
            const content = message.content;
            const start = Math.max(0, matchIndex - 50);
            const end = Math.min(content.length, matchIndex + query.length + 50);
            let preview = content.substring(start, end);
            
            // Add ellipsis if needed
            if (start > 0) preview = '...' + preview;
            if (end < content.length) preview = preview + '...';
            
            // Highlight match
            const highlightedPreview = preview.replace(
                new RegExp(query, 'gi'),
                match => `<strong>${match}</strong>`
            );
            
            const date = new Date(message.timestamp).toLocaleString();
            
            resultItem.innerHTML = `
                <div class="search-result-title">${message.role === 'user' ? 'You' : 'Lynxa Pro'}</div>
                <div class="search-result-preview">${highlightedPreview}</div>
                <div class="search-result-date">${date}</div>
            `;
            
            elements.searchResults.appendChild(resultItem);
        }

        // Hide rename modal
        function hideRenameModal() {
            elements.renameModal.classList.remove('active');
            state.renameChatId = null;
            elements.renameInput.value = '';
        }

        // Save renamed chat
        function saveRenameChat() {
            const newTitle = elements.renameInput.value.trim();
            if (!newTitle) {
                showToast('Chat title cannot be empty', 'error');
                return;
            }
            
            if (state.renameChatId) {
                // In a real implementation, you would update the chat title in Firestore
                showToast('Chat renamed successfully', 'success');
            }
            
            hideRenameModal();
        }

        // Insert code snippet
        function insertCodeSnippet() {
            const codeSnippet = `// Example function\nfunction calculateFactorial(n) {\n    if (n <= 1) return 1;\n    return n * calculateFactorial(n - 1);\n}\n\n// Try it with different values\nconsole.log(calculateFactorial(5));`;
            
            // Insert into Monaco Editor
            if (state.monacoEditor) {
                const position = state.monacoEditor.getPosition();
                const model = state.monacoEditor.getModel();
                const range = new monaco.Range(
                    position.lineNumber,
                    position.column,
                    position.lineNumber,
                    position.column
                );
                
                const text = model.getValueInRange(range);
                const newText = text + codeSnippet;
                
                model.pushEditOperations([{
                    range: range,
                    text: newText
                }]);
                
                // Focus back to the editor
                state.monacoEditor.focus();
            }
            
            showToast('Code snippet inserted', 'success');
        }

        // Toggle settings panel
        function toggleSettingsPanel() {
            elements.settingsPanel.classList.toggle('active');
            elements.overlay.classList.toggle('active');
        }

        // Close settings panel
        function closeSettingsPanel() {
            elements.settingsPanel.classList.remove('active');
            elements.overlay.classList.remove('active');
        }

        // Handle window resize
        function handleWindowResize() {
            updateMobileBackButton();
            adjustMobileViewportHeight();
            
            if (window.innerWidth > 768) {
                elements.sidebar.classList.remove('active');
                elements.overlay.classList.remove('active');
            }
        }

        // Adjust mobile viewport height
        function adjustMobileViewportHeight() {
            if (window.innerWidth <= 768) {
                const isKeyboardOpen = window.visualViewport.height < window.innerHeight * 0.8;
                
                if (isKeyboardOpen) {
                    document.body.classList.add('keyboard-open');
                } else {
                    document.body.classList.remove('keyboard');
                }
            }
        }

        // Handle scroll events to determine if we should auto-scroll
        function handleScroll() {
            const { scrollTop, scrollHeight, clientHeight } = elements.chatMessages;
            const isAtBottom = scrollTop + clientHeight >= scrollHeight - 50; // 50px threshold
            state.autoScroll = isAtBottom;
        }

        // Format date and time
        function formatDateTime(date) {
            if (!date) return '';
            
            // Convert to Date object if it's a string
            if (typeof date === 'string') {
                date = new Date(date);
            }
            
            // Days of the week
            const days = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
            
            // Months of the year
            const months = ['January', 'February', 'March', 'April', 'May', 'June', 
                              'July', 'August', 'September', 'October', 'November', 'December'];
            
            // Get date components
            const dayName = days[date.getDay()];
            const monthName = months[date.getMonth()];
            const day = date.getDate();
            const year = date.getFullYear();
            
            // Format time
            let hours = date.getHours();
            const minutes = date.getMinutes();
            const ampm = hours >= 12 ? 'PM' : 'AM';
            
            // Convert to 12-hour format
            hours = hours % 12;
            hours = hours ? hours : 12; // 0 should be 12
            
            // Add leading zero to minutes if needed
            const formattedMinutes = minutes < 10 ? '0' + minutes : minutes;
            
            // Combine all parts
            return `${dayName}, ${monthName} ${day}, ${year} ${hours}:${formattedMinutes} ${ampm}`;
        }

        // Format time only
        function formatTime(date) {
            if (!date) return '';
            
            // Convert to Date object if it's a string
            if (typeof date === 'string') {
                date = new Date(date);
            }
            
            // Format time
            let hours = date.getHours();
            const minutes = date.getMinutes();
            const ampm = hours >= 12 ? 'PM' : 'AM';
            
            // Convert to 12-hour format
            hours = hours % 12;
            hours = hours ? hours : 12; // 0 should be 12
            
            // Add leading zero to minutes if needed
            const formattedMinutes = minutes < 10 ? '0' + minutes : minutes;
            
            // Combine all parts
            return `${hours}:${formattedMinutes} ${ampm}`;
        }

        // Copy message
        function copyMessage(messageId) {
            const message = state.messages.find(m => m.id === messageId);
            if (!message) return;
            
            navigator.clipboard.writeText(message.content)
                .then(() => {
                    // Update button state
                    const copyBtn = document.querySelector(`button[onclick="copyMessage('${messageId}')"]`);
                    if (copyBtn) {
                        copyBtn.classList.add('copied');
                        setTimeout(() => {
                            copyBtn.classList.remove('copied');
                        }, 2000);
                    }
                    
                    showToast('Message copied to clipboard', 'success');
                })
                .catch(err => {
                    showToast('Failed to copy message', 'error');
                    console.error('Failed to copy:', err);
                });
        }

        // Like message
        function likeMessage(messageId) {
            // If message was disliked, remove from disliked
            if (state.dislikedMessages.has(messageId)) {
                state.dislikedMessages.delete(messageId);
            }
            
            // Toggle like
            if (state.likedMessages.has(messageId)) {
                state.likedMessages.delete(messageId);
                showToast('Removed like', 'success');
            } else {
                state.likedMessages.add(messageId);
                showToast('Liked this response', 'success');
            }
            
            // Update UI
            updateMessageFeedbackUI();
            
            // Save to database
            saveUserData();
        }

        // Dislike message
        function dislikeMessage(messageId) {
            // If message was liked, remove from liked
            if (state.likedMessages.has(messageId)) {
                state.likedMessages.delete(messageId);
            }
            
            // Toggle dislike
            if (state.dislikedMessages.has(messageId)) {
                state.dislikedMessages.delete(messageId);
                showToast('Removed dislike', 'success');
            } else {
                state.dislikedMessages.add(messageId);
                showToast('Disliked this response', 'success');
            }
            
            // Update UI
            updateMessageFeedbackUI();
            
            // Save to database
            saveUserData();
        }

        // Update message feedback UI
        function updateMessageFeedbackUI() {
            document.querySelectorAll('.message-action-btn').forEach(btn => {
                const messageId = btn.getAttribute('onclick').match(/'([^']+)'/)<source_id data="1" title="N/A" />;
                
                if (btn.getAttribute('onclick').includes('likeMessage')) {
                    if (state.likedMessages.has(messageId)) {
                        btn.classList.add('liked');
                    } else {
                        btn.classList.remove('liked');
                    }
                } else if (btn.getAttribute('onclick').includes('dislikeMessage')) {
                    if (state.dislikedMessages.has(messageId)) {
                        btn.classList.add('disliked');
                    } else {
                        btn.classList.remove('disliked');
                    }
                }
            });
        }

        // Show toast notification
        function showToast(message, type = 'success') {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            
            let icon = '';
            if (type === 'success') icon = 'fas fa-check';
            else if (type === 'error') icon = 'fas fa-times';
            else if (type === 'warning') icon = 'fas fa-exclamation';
            
            toast.innerHTML = `
                <div class="toast-icon">
                    <i class="${icon}"></i>
                </div>
                <div class="toast-message">
                    <div class="toast-title">${type.charAt(0).toUpperCase() + type.slice(1)}</div>
                    <div class="toast-description">${message}</div>
                </div>
            `;
            
            elements.toastContainer.appendChild(toast);
            
            // Auto remove after 3 seconds
            setTimeout(() => {
                toast.style.animation = 'slideOut 0.3s ease forwards';
                setTimeout(() => {
                    if (toast.parentNode) {
                        toast.parentNode.removeChild(toast);
                    }
                }, 300);
            }, 3000);
        }

        // Fix mobile viewport height
        function fixMobileViewportHeight() {
            if (window.innerWidth <= 768) {
                const vh = window.innerHeight * 0.01;
                document.documentElement.style.setProperty('--vh', `${vh}px`);
                
                // Update on resize
                window.addEventListener('resize', () => {
                    const vh = window.innerHeight * 0.01;
                    document.documentElement.style.setProperty('--vh', `${vh}px`);
                });
            }
        }

        // Global functions for onclick handlers
        window.copyMessage = copyMessage;
        window.likeMessage = likeMessage;
        window.dislikeMessage = dislikeMessage;
        window.runCodeInEditor = runCodeInEditor;
        window.copyCode = copyCode;
        window.previewHTML = previewHTML;
    </script>
</body>
</html>
